<%- include('partials/header') %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><%= title %></h2>
    <div>
      <button id="bulk-delete-toggle" class="btn btn-danger"><i class="bi bi-trash me-1"></i> Bulk Delete</button>
      <a href="/materials/bulk-upload" class="btn btn-info"><i class="bi bi-upload me-1"></i> Bulk Upload</a>
      <a href="/materials/print-qrcodes" target="_blank" class="btn btn-secondary"><i class="bi bi-printer me-1"></i> Print All QR Codes</a>
      <a href="/materials/add" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Add New Material</a>
    </div>
  </div>

  <% if (message) { %>
    <div class="alert alert-info"><%= message %></div>
  <% } %>

  <!-- Stock Summary -->
  <% if (Object.keys(materialSummary).length > 0) { %>
    <div class="card shadow-sm mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart-line-fill me-2"></i>Stock Summary</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <% Object.entries(materialSummary).forEach(([name, counts]) => { %>
            <div class="col-md-4 col-lg-3 mb-3">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h6 class="card-title"><%= name %></h6>
                  <p class="card-text display-6 fw-bold"><%= counts.Total %></p>
                  <span class="badge bg-success me-1">Available: <%= counts.Available %></span>
                  <span class="badge bg-warning text-dark me-1">Issued: <%= counts.Issued %></span>
                  <span class="badge bg-danger">Damaged: <%= counts.Damaged %></span>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Search and Filter Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form action="/materials" method="GET" class="row g-3 align-items-center">
        <div class="col-md-5">
          <input type="text" name="q" class="form-control" placeholder="Search by Name or Unique ID..." value="<%= filters.q %>">
        </div>
        <div class="col-md-4">
          <select name="status" class="form-select">
            <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Statuses</option>
            <option value="Available" <%= filters.status === 'Available' ? 'selected' : '' %>>Available</option>
            <option value="Issued" <%= filters.status === 'Issued' ? 'selected' : '' %>>Issued</option>
            <option value="Damaged" <%= filters.status === 'Damaged' ? 'selected' : '' %>>Damaged</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i> Filter</button>
          <a href="/materials" class="btn btn-outline-secondary w-100 mt-2">Clear Filters</a>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <form id="bulk-delete-form" action="/materials/bulk-delete" method="POST" onsubmit="return confirm('Are you sure you want to delete all selected items?');">
      <div class="card-header bg-danger text-white" id="bulk-delete-header" style="display: none;">
        <div class="d-flex justify-content-between align-items-center">
          <span>Bulk Delete Mode: <span id="selected-count">0</span> items selected.</span>
          <button type="submit" class="btn btn-light btn-sm">Delete Selected</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th class="bulk-delete-checkbox" style="display: none; width: 1%;"><input type="checkbox" id="select-all-checkbox"></th>
                <th class="text-center">QR Code</th>
                <th>Name</th>
                <th>Description</th>
                <th>Status</th>
                <th class="actions-col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (materials && materials.length > 0) { %>
                <% materials.forEach(material => { %>
                  <tr>
                    <td class="bulk-delete-checkbox" style="display: none;">
                      <input type="checkbox" name="ids[]" value="<%= material.id %>" class="item-checkbox">
                    </td>
                    <td class="text-center">
                      <img src="<%= material.qr_code_path %>" alt="QR Code for <%= material.unique_id %>" width="80"><br>
                      <small class="text-muted font-monospace" style="font-size: 0.8em;"><%= material.unique_id %></small>
                    </td>
                    <td><%= material.name %></td>
                    <td><%= material.description || 'N/A' %></td>
                    <td>
                      <span class="badge bg-<%= material.status === 'Available' ? 'success' : (material.status === 'Issued' ? 'warning' : 'danger') %>">
                        <%= material.status %>
                      </span>
                    </td>
                    <td class="actions-col">
                      <div class="d-flex gap-1">
                        <a href="/materials/history/<%= material.id %>" class="btn btn-sm btn-info">History</a>
                        <form action="/materials/delete/<%= material.id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this item?');" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">No materials found in stock.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        
        <!-- Pagination Controls -->
        <div class="mt-4">
          <%- include('partials/pagination', { pagination, filters }) %>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('bulk-delete-toggle');
    const bulkDeleteHeader = document.getElementById('bulk-delete-header');
    const checkboxes = document.querySelectorAll('.bulk-delete-checkbox');
    const actionsCols = document.querySelectorAll('.actions-col');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
    const selectedCountSpan = document.getElementById('selected-count');

    toggleBtn.addEventListener('click', function() {
        const isBulkMode = this.classList.toggle('active');
        this.textContent = isBulkMode ? 'Cancel Bulk Delete' : 'Bulk Delete';
        this.classList.toggle('btn-secondary');

        bulkDeleteHeader.style.display = isBulkMode ? 'block' : 'none';
        checkboxes.forEach(cb => cb.style.display = isBulkMode ? 'table-cell' : 'none');
        actionsCols.forEach(col => col.style.display = isBulkMode ? 'none' : 'table-cell');
    });

    selectAllCheckbox.addEventListener('change', function() {
        itemCheckboxes.forEach(cb => cb.checked = this.checked);
        updateSelectedCount();
    });

    itemCheckboxes.forEach(cb => cb.addEventListener('change', updateSelectedCount));

    function updateSelectedCount() {
        const count = document.querySelectorAll('.item-checkbox:checked').length;
        selectedCountSpan.textContent = count;
    }
});
</script>

<%- include('partials/footer') %>
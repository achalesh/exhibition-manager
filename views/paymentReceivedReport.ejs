<%- include('partials/header') %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0 text-gray-800"><%= title %></h1>
    <div class="no-print">
      <a href="/report/payment-received/csv?<%- new URLSearchParams(filters).toString() %>" class="btn btn-success btn-sm"><i class="bi bi-download me-1"></i> Download CSV</a>
      <button onclick="window.print()" class="btn btn-secondary btn-sm"><i class="bi bi-printer-fill me-1"></i> Print</button>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="card shadow-sm mb-3 no-print">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Filter Report</h6>
    </div>
    <div class="card-body">
      <form id="filter-form" action="/report/payment-received" method="GET" class="row g-3 align-items-end">
        <input type="hidden" name="category" value="<%= filters.category %>">
        <div class="col-md-3">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" id="start_date" name="start_date" class="form-control" value="<%= filters.start_date %>">
        </div>
        <div class="col-md-3">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" id="end_date" name="end_date" class="form-control" value="<%= filters.end_date %>">
        </div>
        <div class="col-md-4">
          <label for="q" class="form-label">Search by Exhibitor, Space, or Receipt No.</label>
          <input type="text" id="q" name="q" class="form-control" value="<%= filters.q %>" placeholder="e.g., John Doe, A-01, R-123">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Category Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link <%= filters.category === 'all' ? 'active' : '' %>" href="?category=all&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>&q=<%= filters.q %>">All Payments</a></li>
    <li class="nav-item"><a class="nav-link <%= filters.category === 'Rent' ? 'active' : '' %>" href="?category=Rent&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>&q=<%= filters.q %>">Rent</a></li>
    <li class="nav-item"><a class="nav-link <%= filters.category === 'Electric' ? 'active' : '' %>" href="?category=Electric&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>&q=<%= filters.q %>">Electric</a></li>
    <li class="nav-item"><a class="nav-link <%= filters.category === 'Material' ? 'active' : '' %>" href="?category=Material&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>&q=<%= filters.q %>">Material</a></li>
    <li class="nav-item"><a class="nav-link <%= filters.category === 'Shed' ? 'active' : '' %>" href="?category=Shed&start_date=<%= filters.start_date %>&end_date=<%= filters.end_date %>&q=<%= filters.q %>">Shed</a></li>
  </ul>

  <div class="card shadow-sm">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 fw-bold text-primary">Payments Received for: <%= viewingSession.name %></h6>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-striped" id="dataTable">
          <thead class="table-light">
            <tr>
              <th>Date</th>
              <th>Receipt No.</th>
              <th>Exhibitor</th>
              <th>Space</th>
              <th>Category</th>
              <th>Mode</th>
              <th class="text-end">Cash Paid</th>
              <th class="text-end">UPI Paid</th>
              <th class="text-end fw-bold">Total Paid</th>
              <th class="no-print">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (payments.length === 0) { %>
              <tr>
                <td colspan="9" class="text-center">No payments found for the selected criteria.</td>
              </tr>
            <% } else { %>
              <% payments.forEach(p => { %>
                <tr>
                  <td><%= new Date(p.payment_date).toLocaleDateString() %></td>
                  <td><%= p.receipt_number || 'N/A' %></td>
                  <td><%= p.exhibitor_name %></td>
                  <td><%= p.space_name %></td>
                  <td><span class="badge bg-info text-dark"><%= p.payment_category %></span></td>
                  <td><%= p.payment_mode %></td>
                  <td class="text-end"><%= p.cash_paid.toFixed(2) %></td>
                  <td class="text-end"><%= p.upi_paid.toFixed(2) %></td>
                  <td class="text-end fw-bold"><%= p.total_paid.toFixed(2) %></td>
                  <td class="no-print">
                    <a href="/charges/receipt/<%= p.id %>" target="_blank" class="btn btn-sm btn-outline-info" title="View Receipt"><i class="bi bi-receipt"></i></a>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
          <tfoot class="table-light fw-bold">
            <tr>
              <td colspan="6" class="text-end">Grand Total</td>
              <td class="text-end"><%= summary.total_cash.toFixed(2) %></td>
              <td class="text-end"><%= summary.total_upi.toFixed(2) %></td>
              <td class="text-end"><%= summary.total_paid.toFixed(2) %></td>
              <td class="no-print"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center no-print">
      <div class="text-muted">
        Showing <%= Math.min((pagination.currentPage - 1) * 25 + 1, pagination.totalItems) %> to <%= Math.min(pagination.currentPage * 25, pagination.totalItems) %> of <%= pagination.totalItems %> entries
      </div>
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item <%= !pagination.hasPrevPage ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= pagination.currentPage - 1 %>&<%- new URLSearchParams(filters).toString() %>">Previous</a>
          </li>
          <% for(let i = 1; i <= pagination.totalPages; i++) { %>
            <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&<%- new URLSearchParams(filters).toString() %>"><%= i %></a>
            </li>
          <% } %>
          <li class="page-item <%= !pagination.hasNextPage ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= pagination.currentPage + 1 %>&<%- new URLSearchParams(filters).toString() %>">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
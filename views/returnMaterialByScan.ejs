<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><%= title %></h4>
          <% if (user && user.role === 'material_handler') { %>
            <a href="/materials/issue" class="btn btn-light btn-sm"><i class="bi bi-arrow-left-circle"></i> Go to Issue Page</a>
          <% } %>
        </div>
        <div class="card-body">
          <p class="text-muted">Scan a material's QR code or enter its Unique ID below to process its return.</p>

          <!-- QR Code Scanner Section -->
          <div id="reader" style="width: 100%;" class="mb-3"></div>
          <button id="start-scan-btn" class="btn btn-outline-primary w-100 mb-3"><i class="bi bi-qr-code-scan me-2"></i>Start Camera Scan</button>
          <button id="stop-scan-btn" class="btn btn-outline-secondary w-100 mb-3" style="display: none;"><i class="bi bi-camera-video-off me-2"></i>Stop Scanning</button>

          <hr>

          <div class="mb-3">
            <label for="uniqueId" class="form-label">Material Unique ID</label>
            <input type="text" class="form-control" id="uniqueId" placeholder="e.g., NCF/T/BLR/0001" autofocus>
          </div>

          <div class="mb-3">
            <label for="returnNotes" class="form-label">Notes (Optional, recommended for damaged items)</label>
            <textarea class="form-control" id="returnNotes" rows="2"></textarea>
          </div>

          <div class="d-grid gap-2">
            <button id="return-btn" class="btn btn-success"><i class="bi bi-check-circle me-2"></i>Return to Stock</button>
            <button id="damaged-btn" class="btn btn-danger"><i class="bi bi-exclamation-triangle me-2"></i>Mark as Damaged</button>
          </div>

          <div id="result-message" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uniqueIdInput = document.getElementById('uniqueId');
    const returnBtn = document.getElementById('return-btn');
    const damagedBtn = document.getElementById('damaged-btn');
    const resultMessage = document.getElementById('result-message');
    const returnNotesInput = document.getElementById('returnNotes');
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    const readerDiv = document.getElementById('reader');

    async function handleReturn(status) {
        const uniqueId = uniqueIdInput.value.trim();
        if (!uniqueId) {
            uniqueIdInput.focus();
            showMessage('Please enter a Unique ID.', 'warning');
            return;
        }

        // Disable buttons to prevent multiple submissions
        returnBtn.disabled = true;
        damagedBtn.disabled = true;

        const notes = returnNotesInput.value.trim();

        try {
            const response = await fetch('/materials/api/return-item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ uniqueId, status, notes }),
            });

            const result = await response.json();

            if (result.success) {
                showMessage(result.message, 'success');
                uniqueIdInput.value = ''; // Clear input on success
                returnNotesInput.value = ''; // Clear notes on success
            } else {
                showMessage(result.message, 'danger');
            }
        } catch (error) {
            console.error('Error during return:', error);
            showMessage('A network error occurred. Please try again.', 'danger');
        } finally {
            // Re-enable buttons and refocus
            returnBtn.disabled = false;
            damagedBtn.disabled = false;
            uniqueIdInput.focus();
        }
    }

    function showMessage(message, type) {
        resultMessage.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        // Clear the message after 5 seconds
        setTimeout(() => {
            resultMessage.innerHTML = '';
        }, 5000);
    }

    // --- QR Code Scanner Logic ---
    const html5QrCode = new Html5Qrcode("reader");

    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Handle on success condition with the decoded text or result.
        console.log(`Scan result: ${decodedText}`, decodedResult);
        uniqueIdInput.value = decodedText;
        
        // Optional: Automatically trigger the return action
        // For now, we'll just fill the input and let the user choose the action.
        
        // Stop scanning after a successful scan
        stopScanning();
    };

    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    function startScanning() {
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .then(() => {
                startScanBtn.style.display = 'none';
                stopScanBtn.style.display = 'block';
                readerDiv.style.border = '1px solid #dee2e6';
            })
            .catch(err => console.error("Unable to start scanning.", err));
    }

    function stopScanning() {
        html5QrCode.stop()
            .then(() => {
                startScanBtn.style.display = 'block';
                stopScanBtn.style.display = 'none';
                readerDiv.style.border = 'none';
            }).catch(err => console.error("Error stopping the scanner.", err));
    }

    returnBtn.addEventListener('click', () => handleReturn('Available'));
    damagedBtn.addEventListener('click', () => handleReturn('Damaged'));

    // Allow submitting with Enter key
    uniqueIdInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            // Default action on Enter is a standard return
            returnBtn.click();
        }
    });

    startScanBtn.addEventListener('click', startScanning);
    stopScanBtn.addEventListener('click', stopScanning);
});
</script>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container-fluid mt-4">
    <% if (locals.message) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><%= title %></h2>
        <div>
            <a href="/booking/list" class="btn btn-outline-secondary">« Back to List</a>
            <a href="/booking/edit/<%= booking.id %>" class="btn btn-primary">Edit Booking</a>
        </div>
    </div>

    <!-- Exhibitor Details -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4>Exhibitor Details</h4>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Exhibitor Name:</strong> <%= booking.exhibitor_name %></p>
                    <p><strong>Facia Name:</strong> <span class="text-muted"><%= booking.facia_name || 'N/A' %></span></p>
                    <p><strong>Space:</strong> <span class="badge bg-info text-dark fs-6"><%= booking.space_name %></span> (<%= booking.space_type %>)</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Contact Person:</strong> <%= booking.contact_person %></p>
                    <p><strong>Contact Number:</strong> <a href="tel:<%= booking.contact_number %>"><%= booking.contact_number %></a></p>
                    <p><strong>Address:</strong> <%= booking.full_address %></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Financial Summary -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h4>Financial Summary</h4>
        </div>
        <div class="card-body">
            <!-- Rent Details -->
            <h5>Rent</h5>
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th class="text-end">Total Rent</th>
                        <th class="text-end">Discount</th>
                        <th class="text-end">Net Rent</th>
                        <th class="text-end">Paid (incl. Advance)</th>
                        <th class="text-end">Balance Due</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="text-end"><%= booking.financials.rent.charged.toFixed(2) %></td>
                        <td class="text-end text-danger"><%= (booking.discount || 0).toFixed(2) %></td>
                        <td class="text-end"><%= (booking.rent_amount - (booking.discount || 0)).toFixed(2) %></td>
                        <td class="text-end text-success"><%= booking.financials.rent.paid.toFixed(2) %></td>
                        <td class="text-end fw-bold"><%= booking.financials.rent.due.toFixed(2) %></td>
                    </tr>
                </tbody>
            </table>

            <!-- Other Charges Summary -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <h6>Electrical Charges</h6>
                    <p>Total: <%= booking.financials.electric.charged.toFixed(2) %><br>Paid: <%= booking.financials.electric.paid.toFixed(2) %><br><strong>Due: <%= booking.financials.electric.due.toFixed(2) %></strong></p>
                </div>
                <div class="col-md-4">
                    <h6>Material Charges</h6>
                    <p>Total: <%= booking.financials.material.charged.toFixed(2) %><br>Paid: <%= booking.financials.material.paid.toFixed(2) %><br><strong>Due: <%= booking.financials.material.due.toFixed(2) %></strong></p>
                </div>
                <div class="col-md-4">
                    <h6>Shed Charges</h6>
                    <p>Total: <%= booking.financials.shed.charged.toFixed(2) %><br>Paid: <%= booking.financials.shed.paid.toFixed(2) %><br><strong>Due: <%= booking.financials.shed.due.toFixed(2) %></strong></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payments -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Payments Received</h4>
            <a href="/charges/add?booking_id=<%= booking.id %>" class="btn btn-sm btn-outline-success">Receive Payment</a>
        </div>
        <div class="card-body">
            <% const all_payments = booking.payments || []; %>
            <% if (all_payments.length > 0) { %>
                <table class="table table-sm table-striped">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Receipt #</th>
                            <th>Type</th>
                            <th class="text-end">Amount (₹)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% all_payments.forEach(p => { %>
                            <tr>
                                <td><%= new Date(p.payment_date).toLocaleDateString() %></td>
                                <td><%= p.receipt_number || '-' %></td>
                                <td><%= p.type %></td>
                                <td class="text-end fw-bold"><%= p.amount.toFixed(2) %></td>
                                <td>
                                    <a href="/charges/edit/<%= p.id %>" class="btn btn-sm btn-outline-primary">Edit</a>
                                    <% if (user && user.role === 'admin') { %>
                                        <form action="/charges/delete/<%= p.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this payment?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p class="text-center text-muted">No payments have been recorded yet.</p>
            <% } %>
        </div>
    </div>

    <!-- Material Issues -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Material Issues</h4>
            <a href="/material/issue?client_id=<%= booking.client_id %>" class="btn btn-sm btn-outline-primary">Issue New Material</a>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Sl.No</th>
                        <th>Date</th>
                        <th>Items (Free/Paid)</th>
                        <th class="text-right">Total Amount</th>
                        <th class="text-right">Paid Amount</th>
                        <th class="text-right fw-bold">Balance Due</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (materials && materials.length > 0) { %>
                        <% materials.forEach(issue => { %>
                            <tr>
                                <td><%= issue.sl_no || 'N/A' %></td>
                                <td><%= new Date(issue.issue_date).toLocaleDateString() %></td>
                                <td>
                                    Plywood: <%= issue.plywood_free %>/<%= issue.plywood_paid %><br>
                                    Table: <%= issue.table_free %>/<%= issue.table_paid %><br>
                                    Chair: <%= issue.chair_free %>/<%= issue.chair_paid %>
                                </td>
                                <td class="text-right"><%= (issue.total_payable || 0).toFixed(2) %></td>
                                <td class="text-right"><%= (issue.advance_paid || 0).toFixed(2) %></td>
                                <td class="text-right fw-bold"><%= (issue.balance_due || 0).toFixed(2) %></td>
                                <td>
                                    <a href="/material/edit/<%= issue.id %>" class="btn btn-sm btn-warning">Edit</a>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr><td colspan="7" class="text-center">No material issues found.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Electric Bills -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Electric Bills</h4>
            <a href="/electric/add?booking_id=<%= booking.id %>" class="btn btn-sm btn-outline-primary">Add New Bill</a>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Sl.No</th>
                        <th>Date</th>
                        <th>Items & Quantity</th>
                        <th class="text-right">Total Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (electricBills && electricBills.length > 0) { %>
                        <% electricBills.forEach(bill => { %>
                            <tr>
                                <td><%= bill.sl_no || 'N/A' %></td>
                                <td><%= new Date(bill.bill_date).toLocaleDateString() %></td>
                                <td>
                                    <% bill.items.forEach(item => { %>
                                        <%= item.name %> (Qty: <%= item.quantity %>)<br>
                                    <% }); %>
                                </td>
                                <td class="text-right"><%= (bill.total_amount || 0).toFixed(2) %></td>
                                <td>
                                    <a href="/electric/edit/<%= bill.id %>" class="btn btn-sm btn-warning">Edit</a>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr><td colspan="5" class="text-center">No electric bills found.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Shed Allocations -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Shed Allocations</h4>
            <a href="/shed/allocate?booking_id=<%= booking.id %>" class="btn btn-sm btn-outline-primary">Allocate New Shed</a>
        </div>
        <div class="card-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Shed Name</th>
                        <th>Allocation Date</th>
                        <th class="text-end">Rent (₹)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (shedAllocations && shedAllocations.length > 0) { %>
                        <% shedAllocations.forEach(alloc => { %>
                            <tr>
                                <td><%= alloc.shed_name %></td>
                                <td><%= new Date(alloc.allocation_date).toLocaleDateString() %></td>
                                <td class="text-end"><%= (alloc.rent || 0).toFixed(2) %></td>
                                <td>
                                    <% if (user && user.role === 'admin') { %>
                                        <form action="/shed/allocation/delete/<%= alloc.id %>" method="POST" onsubmit="return confirm('Are you sure you want to de-allocate this shed? This will reverse the rent charge.');">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr><td colspan="4" class="text-center">No sheds allocated.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>

</div>

<%- include('partials/footer') %>
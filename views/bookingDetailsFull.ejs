<%- include('partials/header') %>

<%
  // Determine if the page should be read-only.
  const isReadOnly = viewingSession.id !== activeSession.id;
%>

<div class="container-fluid">
  <!-- Navigation -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <a href="/booking/list" class="btn btn-outline-secondary btn-sm">« Back to Booking List</a>
    </div>
    <div>
      <% if (previousId) { %>
        <a href="/booking/details-full/<%= previousId %>" class="btn btn-secondary btn-sm">← Previous</a>
      <% } %>
      <% if (nextId) { %>
        <a href="/booking/details-full/<%= nextId %>" class="btn btn-secondary btn-sm">Next →</a>
      <% } %>
    </div>
  </div>

  <!-- Exhibitor Details Card -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Exhibitor Details: <%= booking.exhibitor_name %></h4>
      <div class="no-print">
        <a href="/booking/edit/<%= booking.id %>" class="btn btn-light btn-sm <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-pencil-square me-1"></i> Edit Booking</a>
        <% if (booking.booking_status === 'active' && !isReadOnly) { %>
          <form action="/booking/vacate/<%= booking.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to vacate this space? This will allow it to be re-booked.');">
            <button type="submit" class="btn btn-warning btn-sm"><i class="bi bi-door-open-fill me-1"></i> Vacate Space</button>
          </form>
        <% } %>
        <button onclick="window.print()" class="btn btn-light btn-sm"><i class="bi bi-printer-fill me-1"></i> Print</button>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Facia Name:</strong> <%= booking.facia_name || 'N/A' %></p>
          <p><strong>Space:</strong> <%= booking.space_name %> (<%= booking.space_type %>)</p>
          <p><strong>Booking Status:</strong> 
            <span class="badge bg-<%= booking.booking_status === 'active' ? 'success' : 'secondary' %>">
              <%= booking.booking_status.charAt(0).toUpperCase() + booking.booking_status.slice(1) %>
            </span>
            <% if (booking.vacated_date) { %> (on <%= new Date(booking.vacated_date).toLocaleDateString() %>)<% } %>
          </p>
          <p><strong>Product Category:</strong> <%= booking.product_category || 'N/A' %></p>
        </div>
        <div class="col-md-6">
          <p><strong>Contact Person:</strong> <%= booking.contact_person %></p>
          <p><strong>Contact Number:</strong> <%= booking.contact_number %></p>
          <p><strong>Address:</strong> <%= booking.full_address || 'N/A' %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Left Column: Financials -->
    <div class="col-lg-7">
      <!-- Financial Summary -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>Financial Summary</h5>
          <div class="no-print">
            <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#writeOffModal" <%= isReadOnly ? 'disabled' : '' %>><i class="bi bi-eraser-fill me-1"></i> Write-Off</button>
          </div>
        </div>
        <div class="card-body p-0">
          <table class="table table-bordered table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th>Category</th>
                <th class="text-end">Total Charged (₹)</th>
                <th class="text-end">Total Paid (₹)</th>
                <th class="text-end">Balance Due (₹)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Rent</td>
                <td class="text-end"><%= booking.financials.rent.charged.toFixed(2) %></td>
                <td class="text-end text-success"><%= booking.financials.rent.paid.toFixed(2) %></td>
                <td class="text-end fw-bold <%= booking.financials.rent.due > 0 ? 'text-danger' : '' %>"><%= booking.financials.rent.due.toFixed(2) %></td>
              </tr>
              <tr>
                <td>Electric</td>
                <td class="text-end"><%= booking.financials.electric.charged.toFixed(2) %></td>
                <td class="text-end text-success"><%= booking.financials.electric.paid.toFixed(2) %></td>
                <td class="text-end fw-bold <%= booking.financials.electric.due > 0 ? 'text-danger' : '' %>"><%= booking.financials.electric.due.toFixed(2) %></td>
              </tr>
              <tr>
                <td>Material</td>
                <td class="text-end"><%= booking.financials.material.charged.toFixed(2) %></td>
                <td class="text-end text-success"><%= booking.financials.material.paid.toFixed(2) %></td>
                <td class="text-end fw-bold <%= booking.financials.material.due > 0 ? 'text-danger' : '' %>"><%= booking.financials.material.due.toFixed(2) %></td>
              </tr>
              <tr>
                <td>Shed</td>
                <td class="text-end"><%= booking.financials.shed.charged.toFixed(2) %></td>
                <td class="text-end text-success"><%= booking.financials.shed.paid.toFixed(2) %></td>
                <td class="text-end fw-bold <%= booking.financials.shed.due > 0 ? 'text-danger' : '' %>"><%= booking.financials.shed.due.toFixed(2) %></td>
              </tr>
              <% if (booking.financials.write_offs.amount > 0) { %>
              <tr class="table-warning">
                <td>Write-Offs</td>
                <td class="text-end" colspan="2">- <%= booking.financials.write_offs.amount.toFixed(2) %></td>
                <td class="text-end fw-bold text-danger">- <%= booking.financials.write_offs.amount.toFixed(2) %></td>
              </tr>
              <% } %>
            </tbody>
            <tfoot class="table-dark">
              <%
                const grandTotalCharged = booking.financials.rent.charged + booking.financials.electric.charged + booking.financials.material.charged + booking.financials.shed.charged;
                const grandTotalPaid = booking.financials.rent.paid + booking.financials.electric.paid + booking.financials.material.paid + booking.financials.shed.paid;
                const totalWriteOffs = booking.financials.write_offs.amount;
                const grandTotalDue = grandTotalCharged - grandTotalPaid - totalWriteOffs;
              %>
              <tr>
                <td class="text-end"><strong>Grand Total</strong></td>
                <td class="text-end"><strong><%= grandTotalCharged.toFixed(2) %></strong></td>
                <td class="text-end"><strong><%= grandTotalPaid.toFixed(2) %></strong></td>
                <td class="text-end fw-bold <%= grandTotalDue > 0 ? 'text-danger' : '' %>"><strong><%= grandTotalDue.toFixed(2) %></strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Payment History -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Payment History</h5>
          <a href="/charges/add?booking_id=<%= booking.id %>" class="btn btn-success btn-sm no-print <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-plus-circle me-1"></i> Add Payment</a>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                <th>Receipt No.</th>
                <th>Type</th>
                <th class="text-end">Amount (₹)</th>
                <th>Remarks</th>
                <th class="no-print">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (booking.advance_amount > 0) { %>
                <tr>
                  <td><%= new Date(booking.booking_date).toLocaleDateString() %></td>
                  <td>ADVANCE</td>
                  <td>Rent</td>
                  <td class="text-end"><%= booking.advance_amount.toFixed(2) %></td>
                  <td class="no-print">---</td>
                </tr>
              <% } %>
              <% if (booking.payments && booking.payments.length > 0) { %>
                <% booking.payments.forEach(p => { %>
                  <tr>
                    <td><%= new Date(p.payment_date).toLocaleDateString() %></td>
                    <td><%= p.receipt_number || 'N/A' %></td>
                    <td><%= p.type %></td>
                    <td class="text-end"><%= p.amount.toFixed(2) %></td>
                    <td class="text-muted fst-italic"><%= p.remarks || '' %></td>
                    <td class="no-print">
                      <div class="d-flex gap-2">
                        <a href="/charges/receipt/<%= p.id %>" target="_blank" class="btn btn-sm btn-info">Receipt</a>
                        <a href="/charges/edit/<%= p.id %>" class="btn btn-sm btn-primary <%= isReadOnly ? 'disabled' : '' %>">Edit</a>
                        <form action="/charges/delete/<%= p.id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this payment? This action cannot be undone.');">
                          <button type="submit" class="btn btn-sm btn-danger" <%= isReadOnly ? 'disabled' : '' %>>Delete</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else if (booking.advance_amount <= 0) { %>
                <tr>
                  <td colspan="6" class="text-center text-muted">No payments recorded yet.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right Column: Other Charges -->
    <div class="col-lg-5">
      <!-- Electric Bills -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-lightning-charge-fill me-2"></i>Electric Bills</h5>
          <a href="/electric/add?booking_id=<%= booking.id %>" class="btn btn-success btn-sm no-print <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-plus-circle me-1"></i> Add Bill</a>
        </div>
        <div class="card-body">
          <% if (electricBills && electricBills.length > 0) { %>
            <% electricBills.forEach(bill => { %>
              <div class="border p-3 mb-3 rounded">
                <div class="d-flex justify-content-between">
                  <h6>Bill #<%= bill.sl_no || bill.id %> - Date: <%= new Date(bill.bill_date).toLocaleDateString() %></h6>
                  <div class="no-print">
                    <a href="/electric/edit/<%= bill.id %>" class="btn btn-sm btn-primary <%= isReadOnly ? 'disabled' : '' %>">Edit</a>
                    <form action="/electric/delete/<%= bill.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure?');">
                      <button type="submit" class="btn btn-sm btn-danger" <%= isReadOnly ? 'disabled' : '' %>>Delete</button>
                    </form>
                  </div>
                </div>
                <ul>
                  <% bill.items.forEach(item => { %>
                    <li><%= item.name %>: <%= item.quantity %> x ₹<%= item.rate %> = ₹<%= item.total %></li>
                  <% }) %>
                </ul>
                <p class="text-end fw-bold">Total: ₹<%= bill.total_amount.toFixed(2) %></p>
              </div>
            <% }) %>
          <% } else { %>
            <p class="text-muted">No electric bills issued.</p>
          <% } %>
        </div>
      </div>

      <!-- Material Issues -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Material Issues</h5>
          <div class="no-print">
            <a href="/materials/issue?client_id=<%= booking.client_id %>" class="btn btn-primary btn-sm <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-qr-code-scan me-1"></i> Issue by QR</a>
            <a href="/material/issue?client_id=<%= booking.client_id %>" class="btn btn-success btn-sm <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-receipt-cutoff me-1"></i> Add Billable Materials</a>
          </div>
        </div>
        <div class="card-body">
          <% if (materials && materials.length > 0) { %>
            <% materials.forEach(issue => { %>
              <div class="border p-3 mb-3 rounded">
                <div class="d-flex justify-content-between">
                  <h6>Issue #<%= issue.sl_no || issue.id %> - Date: <%= new Date(issue.issue_date).toLocaleDateString() %></h6>
                  <div class="no-print d-flex gap-2">
                    <a href="/material/edit/<%= issue.id %>" class="btn btn-sm btn-primary <%= isReadOnly ? 'disabled' : '' %>">Edit</a>
                    <form action="/material/delete/<%= issue.id %>" method="POST" onsubmit="return confirm('Are you sure you want to return these materials? This will reverse any charges and delete the issue record.');">
                      <button type="submit" class="btn btn-sm btn-warning" title="Return Materials" <%= isReadOnly ? 'disabled' : '' %>>
                        <i class="bi bi-arrow-return-left"></i> Return
                      </button>
                    </form>
                  </div>
                </div>
                <p><strong>Total Payable:</strong> ₹<%= (issue.total_payable || 0).toFixed(2) %></p>
                <% if (issue.table_numbers || issue.chair_numbers) { %>
                  <div class="mt-2">
                    <small class="text-muted">
                      <strong>Asset Details:</strong><br>
                      <% if (issue.table_numbers) { %><span>Tables: <%= issue.table_numbers %></span><br><% } %>
                      <% if (issue.chair_numbers) { %><span>Chairs: <%= issue.chair_numbers %></span><% } %>
                    </small>
                  </div>
                <% } %>
              </div>
            <% }) %>
            <% if (issuedMaterialCount > 0) { %>
              <div class="mt-3 text-end">
                <a href="/materials/issued-to/<%= booking.client_id %>" class="btn btn-sm btn-info">View <%= issuedMaterialCount %> Issued QR Items</a>
              </div>
            <% } %>
          <% } else { %>
            <p class="text-muted">No materials issued.</p>
          <% } %>
        </div>
      </div>

      <!-- Shed Allocations -->
      <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-shop me-2"></i>Shed Allocations</h5>
          <a href="/shed/allocate?booking_id=<%= booking.id %>" class="btn btn-success btn-sm no-print <%= isReadOnly ? 'disabled' : '' %>"><i class="bi bi-plus-circle me-1"></i> Allocate Shed</a>
        </div>
        <div class="card-body">
          <% if (shedAllocations && shedAllocations.length > 0) { %>
            <ul class="list-group">
              <% shedAllocations.forEach(alloc => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span><strong><%= alloc.shed_name %></strong> (Rent: ₹<%= alloc.rent.toFixed(2) %>) - Allocated on <%= new Date(alloc.allocation_date).toLocaleDateString() %></span>
                  <form action="/shed/allocation/delete/<%= alloc.id %>" method="POST" class="d-inline no-print" onsubmit="return confirm('Are you sure?');">
                    <button type="submit" class="btn btn-sm btn-danger" <%= isReadOnly ? 'disabled' : '' %>>De-allocate</button>
                  </form>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-muted">No sheds allocated.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Write-Off Modal -->
  <div class="modal fade" id="writeOffModal" tabindex="-1" aria-labelledby="writeOffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="writeOffModalLabel">Write-Off Due Amount</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form action="/booking/write-off/<%= booking.id %>" method="POST">
          <div class="modal-body">
            <p>Enter the amount to write off for <strong><%= booking.exhibitor_name %></strong>. This action will be recorded as an expenditure and cannot be undone.</p>
            <div class="mb-3">
              <label for="writeOffAmount" class="form-label">Amount to Write-Off (₹)</label>
              <input type="number" class="form-control" id="writeOffAmount" name="amount" step="0.01" required min="0.01">
            </div>
            <div class="mb-3">
              <label for="writeOffReason" class="form-label">Reason for Write-Off</label>
              <textarea class="form-control" id="writeOffReason" name="reason" rows="3" required placeholder="e.g., Damaged goods compensation, marketing adjustment, etc."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Confirm Write-Off</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0"><%= title %> - <%= booking.exhibitor_name %></h1>
        <div>
            <% if (previousId) { %>
                <a href="/booking/details-full/<%= previousId %>" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Prev</a>
            <% } %>
            <% if (nextId) { %>
                <a href="/booking/details-full/<%= nextId %>" class="btn btn-outline-secondary">Next <i class="bi bi-arrow-right"></i></a>
            <% } %>
        </div>
    </div>

    <% if (rebookedFromInfo) { %>
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i>
            This exhibitor was re-booked from the "<strong><%= rebookedFromInfo.session_name %></strong>" session. 
            <a href="/booking/details-full/<%= rebookedFromInfo.original_booking_id %>?view_session_id=<%= rebookedFromInfo.original_session_id %>" class="alert-link">View original booking</a>.
        </div>
    <% } %>

    <% if (booking.booking_status === 'unallocated') { %>
        <div class="card bg-warning-subtle border-warning mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-house-add-fill me-2"></i>Allocate a Space</h5>
            </div>
            <div class="card-body">
                <p>This exhibitor is registered but has not been assigned a space yet. Select an available space below to complete the booking.</p>
                <form action="/booking/allocate/<%= booking.id %>" method="POST" id="allocateSpaceForm">
                    <div class="row align-items-end">
                        <div class="col-md-12 mb-3">
                            <label for="space_id" class="form-label">Available Spaces</label>
                            <div class="space-selection-box border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                <% availableSpaces.forEach(space => { %>
                                    <div class="form-check">
                                        <input class="form-check-input space-checkbox" type="checkbox" name="space_ids" value="<%= space.id %>" id="space_<%= space.id %>" data-rent="<%= space.rent_amount %>">
                                        <label class="form-check-label" for="space_<%= space.id %>">
                                            <strong><%= space.name %></strong> (<%= space.type %>) - ₹<%= space.rent_amount.toFixed(2) %>
                                        </label>
                                    </div>
                                <% }) %>
                                <% if (availableSpaces.length === 0) { %>
                                    <p class="text-muted text-center mb-0">No spaces are currently available.</p>
                                <% } %>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Total Rent</label>
                            <input type="text" class="form-control" id="total_rent_display" value="₹0.00" readonly>
                        </div>
                        <div class="col-md-4">
                            <label for="discount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="discount" name="discount" value="0" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">Allocate Space</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    <% } %>

    <div class="row">
        <!-- Left Column: Booking & Financial Details -->
        <div class="col-lg-8">
            <!-- Booking Details Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Exhibitor Details</h5>
                    <span class="badge fs-6 <%= booking.booking_status === 'active' ? 'bg-success' : 'bg-secondary' %> text-capitalize"><%= booking.booking_status %></span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Exhibitor:</strong> <%= booking.exhibitor_name %></p>
                            <p><strong>Facia Name:</strong> <%= booking.facia_name || 'N/A' %></p>
                            <p><strong>Product Category:</strong> <%= booking.product_category || 'N/A' %></p>
                            <p><strong>Space:</strong> <%= booking.space_name || 'N/A' %> (<%= booking.space_type || 'N/A' %>)</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Contact Person:</strong> <%= booking.contact_person %></p>
                            <p><strong>Contact Number:</strong> <%= booking.contact_number %></p>
                            <p><strong>Secondary Number:</strong> <%= booking.secondary_number || 'N/A' %></p>
                            <p><strong>Address:</strong> <%= booking.full_address || 'N/A' %></p>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <div>
                            <p><strong>Booking Date:</strong> <%= new Date(booking.booking_date).toLocaleDateString('en-GB') %></p>
                            <p class="mb-0"><strong>Form Submitted:</strong> <span class="badge <%= booking.form_submitted ? 'bg-success' : 'bg-warning' %>"><%= booking.form_submitted ? 'Yes' : 'No' %></span></p>
                        </div>
                        <div class="align-self-end">
                            <% if (booking.booking_status !== 'unallocated') { %>
                                <a href="/booking/rebook/<%= booking.id %>" class="btn btn-sm btn-info">Re-book for Next Session</a>
                            <% } %>
                            <a href="/booking/edit/<%= booking.id %>" class="btn btn-sm btn-outline-primary">Edit Details</a>
                            <% if (booking.booking_status === 'active') { %>
                                <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#deallocateModal">De-allocate Space</button>
                            <% } %>
                            <% if (booking.booking_status === 'active') { %>
                                <form action="/booking/vacate/<%= booking.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to cancel this booking and reverse all charges? This cannot be undone.');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Cancel Booking</button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financial Summary Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-wallet2 me-2"></i>Financial Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="text-end">Charged</th>
                                <th class="text-end">Paid</th>
                                <th class="text-end">Due</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Rent</td>
                                <td class="text-end">₹<%= booking.financials.rent.charged.toFixed(2) %></td>
                                <td class="text-end">₹<%= booking.financials.rent.paid.toFixed(2) %></td>
                                <td class="text-end fw-bold <%= booking.financials.rent.due > 0 ? 'text-danger' : '' %>">₹<%= booking.financials.rent.due.toFixed(2) %></td>
                            </tr>
                            <tr>
                                <td>Electric</td>
                                <td class="text-end">₹<%= booking.financials.electric.charged.toFixed(2) %></td>
                                <td class="text-end">₹<%= booking.financials.electric.paid.toFixed(2) %></td>
                                <td class="text-end fw-bold <%= booking.financials.electric.due > 0 ? 'text-danger' : '' %>">₹<%= booking.financials.electric.due.toFixed(2) %></td>
                            </tr>
                            <tr>
                                <td>Material</td>
                                <td class="text-end">₹<%= booking.financials.material.charged.toFixed(2) %></td>
                                <td class="text-end">₹<%= booking.financials.material.paid.toFixed(2) %></td>
                                <td class="text-end fw-bold <%= booking.financials.material.due > 0 ? 'text-danger' : '' %>">₹<%= booking.financials.material.due.toFixed(2) %></td>
                            </tr>
                             <tr>
                                <td>Shed</td>
                                <td class="text-end">₹<%= booking.financials.shed.charged.toFixed(2) %></td>
                                <td class="text-end">₹<%= booking.financials.shed.paid.toFixed(2) %></td>
                                <td class="text-end fw-bold <%= booking.financials.shed.due > 0 ? 'text-danger' : '' %>">₹<%= booking.financials.shed.due.toFixed(2) %></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="table-light fw-bold">
                                <td>Total</td>
                                <td class="text-end">₹<%= (booking.financials.rent.charged + booking.financials.electric.charged + booking.financials.material.charged + booking.financials.shed.charged).toFixed(2) %></td>
                                <td class="text-end">₹<%= (booking.financials.rent.paid + booking.financials.electric.paid + booking.financials.material.paid + booking.financials.shed.paid).toFixed(2) %></td>
                                <td class="text-end text-danger">₹<%= (booking.financials.rent.due + booking.financials.electric.due + booking.financials.material.due + booking.financials.shed.due).toFixed(2) %></td>
                            </tr>
                        </tfoot>
                    </table>
                     <% if (booking.financials.write_offs.amount > 0) { %>
                        <div class="alert alert-info small p-2">
                            <strong>Note:</strong> An amount of ₹<%= booking.financials.write_offs.amount.toFixed(2) %> has been written off for this booking.
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Payments Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Payments</h5>
                    <a href="/charges/add?booking_id=<%= booking.id %>" class="btn btn-sm btn-success">Add Payment</a>
                </div>
                <div class="card-body">
                    <% if (booking.advance_amount > 0) { %>
                        <p><strong>Initial Advance:</strong> ₹<%= booking.advance_amount.toFixed(2) %></p>
                    <% } %>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Receipt #</th>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (booking.payments.length > 0) { %>
                                <% booking.payments.forEach(p => { %>
                                    <tr>
                                        <td><%= new Date(p.payment_date).toLocaleDateString('en-GB') %></td>
                                        <td><%= p.receipt_number %></td>
                                        <td><%= p.type %></td>
                                        <td class="text-end">₹<%= p.amount.toFixed(2) %></td>
                                        <td>
                                            <a href="/charges/receipt/<%= p.id %>" class="btn btn-sm btn-outline-secondary" target="_blank">Print</a>
                                            <a href="/charges/edit/<%= p.id %>" class="btn btn-sm btn-outline-primary">Edit</a>
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else if (booking.advance_amount <= 0) { %>
                                <tr><td colspan="5" class="text-center">No payments recorded yet.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Column: Other Charges & Actions -->
        <div class="col-lg-4">
            <!-- Actions Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Other Charges</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="/electric/add?booking_id=<%= booking.id %>" class="list-group-item list-group-item-action">Add Electric Bill</a>
                    <a href="/material/issue?client_id=<%= booking.client_id %>" class="list-group-item list-group-item-action">Issue Materials (Form)</a>
                    <a href="/materials/issue?client_id=<%= booking.client_id %>" class="list-group-item list-group-item-action">Issue Materials (QR Scan)</a>
                    <a href="/shed/allocate?booking_id=<%= booking.id %>" class="list-group-item list-group-item-action">Allocate Shed</a>
                    <a href="/shed/bill?booking_id=<%= booking.id %>" class="list-group-item list-group-item-action">Add Shed Bill</a>
                </div>
            </div>

            <!-- Electric Bills Card -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Electric Bills</h5></div>
                <ul class="list-group list-group-flush">
                    <% if (electricBills.length > 0) { %>
                        <% electricBills.forEach(bill => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><%= new Date(bill.bill_date).toLocaleDateString('en-GB') %></span>
                                <span class="fw-bold">₹<%= bill.total_amount.toFixed(2) %></span>
                                <div>
                                    <a href="/electric/edit/<%= bill.id %>" class="btn btn-sm btn-outline-primary">Edit</a>
                                </div>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="list-group-item text-center text-muted">No electric bills.</li>
                    <% } %>
                </ul>
            </div>

            <!-- Material Issues Card -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Material Issues (Form)</h5></div>
                <ul class="list-group list-group-flush">
                    <% if (materials.length > 0) { %>
                        <% materials.forEach(issue => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>SL# <%= issue.sl_no %> (<%= new Date(issue.issue_date).toLocaleDateString('en-GB') %>)</span>
                                <span class="fw-bold">₹<%= issue.total_payable.toFixed(2) %></span>
                                <div>
                                    <a href="/material/edit/<%= issue.id %>" class="btn btn-sm btn-outline-primary">Edit</a>
                                </div>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="list-group-item text-center text-muted">No materials issued via form.</li>
                    <% } %>
                </ul>
                <div class="card-footer">
                     <a href="/materials/issued-to/<%= booking.client_id %>">View QR-Issued Materials (<%= issuedMaterialCount %>)</a>
                </div>
            </div>

            <!-- Shed Allocations Card -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Shed Allocations</h5></div>
                <ul class="list-group list-group-flush">
                    <% if (shedAllocations.length > 0) { %>
                        <% shedAllocations.forEach(alloc => { %>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><%= alloc.shed_name %></span>
                                <span class="fw-bold">₹<%= alloc.rent.toFixed(2) %></span>
                                <form action="/shed/allocation/delete/<%= alloc.id %>" method="POST" onsubmit="return confirm('Are you sure you want to de-allocate this shed?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                                </form>
                            </li>
                        <% }) %>
                    <% } else { %>
                        <li class="list-group-item text-center text-muted">No sheds allocated.</li>
                    <% } %>
                </ul>
            </div>

            <!-- Write-off Card -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0">Write-Off Amount</h5></div>
                <div class="card-body">
                    <form action="/booking/write-off/<%= booking.id %>" method="POST" onsubmit="return confirm('Are you sure you want to write-off this amount? This is for recording bad debt and cannot be easily undone.');">
                        <div class="mb-2">
                            <label for="writeoff-amount" class="form-label">Amount to Write-Off</label>
                            <input type="number" class="form-control" id="writeoff-amount" name="amount" step="0.01" required>
                        </div>
                        <div class="mb-2">
                            <label for="writeoff-reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="writeoff-reason" name="reason" required>
                        </div>
                        <button type="submit" class="btn btn-sm btn-warning">Write-Off</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- De-allocate Modal -->
<div class="modal fade" id="deallocateModal" tabindex="-1" aria-labelledby="deallocateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deallocateModalLabel">Confirm De-allocation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to de-allocate the space from this booking?</p>
        <p>This will:</p>
        <ul>
            <li>Make the space available for others.</li>
            <li>Reset the booking status to <strong>Unallocated</strong>.</li>
            <li>Remove the rent charge and any discount.</li>
            <li><strong>Keep</strong> any advance payments and other charges (Electric, Material, Shed).</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="/booking/deallocate/<%= booking.id %>" method="POST"><button type="submit" class="btn btn-warning">De-allocate</button></form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('allocateSpaceForm');
    if (form) {
        const checkboxes = form.querySelectorAll('.space-checkbox');
        const totalRentDisplay = document.getElementById('total_rent_display');

        function updateTotalRent() {
            let totalRent = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    totalRent += parseFloat(cb.dataset.rent) || 0;
                }
            });
            totalRentDisplay.value = `₹${totalRent.toFixed(2)}`;
        }
        checkboxes.forEach(cb => cb.addEventListener('change', updateTotalRent));
    }
});
</script>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container-fluid">
  <%- include('partials/ticketingNav') %>

  <div class="card shadow-sm mb-4 no-print">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 fw-bold text-primary">Distribute New Ticket Bundle</h6>
      <a href="/ticketing/distribute/bulk" class="btn btn-sm btn-info shadow-sm">
        <i class="bi bi-upload me-1"></i> Bulk Distribute
      </a>
    </div>
    <div class="card-body">
      <form action="/ticketing/distribute" method="POST">
        <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label for="distribution_date" class="form-label">Date</label>
          <input type="date" class="form-control" id="distribution_date" name="distribution_date" value="<%= new Date().toISOString().split('T')[0] %>" required autofocus>
        </div>
        <div class="col-md-2">
          <label for="staff_id" class="form-label">Staff Member</label>
          <select id="staff_id" name="staff_id" class="form-select" required>
            <option value="" disabled selected>Select Staff...</option>
            <% staff.forEach(s => { %>
              <option value="<%= s.id %>"><%= s.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-3">
          <label for="ride_id" class="form-label">Assign to Ride / Entry</label>
          <select id="ride_id" name="ride_id" class="form-select" required>
            <option value="" disabled selected>Select a ride...</option>
            <% rides.forEach(ride => { %>
              <option value="<%= ride.id %>" data-rate="<%= ride.rate %>"><%= ride.name %> (₹<%= ride.rate %>)</option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-3">
          <label for="stock_id" class="form-label">From Available Stock</label>
          <select id="stock_id" name="stock_id" class="form-select" required>
            <option value="" disabled selected>Select a ride first...</option> 
            <% stock.forEach(s => { %>
              <option value="<%= s.id %>" data-rate="<%= s.rate %>" class="d-none stock-option">
                <%= s.color %> bundle (₹<%= s.rate %>) | Nos: <%= s.start_number %> - <%= s.end_number %>
              </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Distribute Bundle</button>
        </div>
        </div>
      </form>
    </div>
  </div>

  <div class="alert alert-info">
    <h5 class="alert-heading">Workflow</h5>
    <p>1. Select a staff member and the ride/entry point they will be working at. <br> 2. The "From Available Stock" dropdown will automatically show ticket bundles that match the ride's rate. <br> 3. Select a bundle and click "Distribute".</p>
    <p class="mb-0">After the shift, go to the <strong>Settle Sales</strong> page to enter the returned ticket numbers and calculate the revenue.</p>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header py-3">
    <h6 class="m-0 fw-bold text-primary">Currently Distributed Tickets</h6>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered" id="dataTable">
        <thead>
          <tr>
            <th>Staff Member</th>
            <th>Ride Name</th>
            <th>Color</th>
            <th>Serial Range</th>
            <th>Date Distributed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% distributedTickets.forEach(d => { %>
            <tr>
              <td><%= d.staff_name %></td>
              <td><%= d.ride_name %></td>
              <td><span class="badge" style="background-color: <%= d.color ? d.color.toLowerCase() : 'grey' %>;"><%= d.color %></span></td>
              <td><%= d.start_number %> - <%= d.end_number %></td>
              <td><%= new Date(d.distribution_date).toLocaleDateString() %></td>
              <td>
                <a href="/ticketing/distribute/edit/<%= d.id %>" class="btn btn-sm btn-warning me-1" title="Edit"><i class="bi bi-pencil"></i></a>
                <form action="/ticketing/distribute/delete/<%= d.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to recall this ticket bundle?');">
                  <button type="submit" class="btn btn-sm btn-danger" title="Recall Bundle"><i class="bi bi-arrow-return-left"></i></button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const rideSelect = document.getElementById('ride_id');
    const stockSelect = document.getElementById('stock_id');
    const stockOptions = document.querySelectorAll('.stock-option');

    rideSelect.addEventListener('change', function() {
      const selectedRideOption = this.options[this.selectedIndex];
      const selectedRate = selectedRideOption.getAttribute('data-rate');
      
      // Reset stock dropdown
      stockSelect.value = '';
      let hasMatchingStock = false;

      // Hide all options first
      stockOptions.forEach(option => {
        option.classList.add('d-none');
      });

      // Show only matching options
      stockOptions.forEach(option => {
        if (option.getAttribute('data-rate') === selectedRate) {
          option.classList.remove('d-none');
          hasMatchingStock = true;
        }
      });

      // Update placeholder text
      const placeholder = stockSelect.querySelector('option[disabled]');
      placeholder.textContent = hasMatchingStock ? 'Select a stock bundle...' : 'No available stock for this rate';
    });
  });
</script>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container-fluid">
  <%- include('partials/ticketingNav') %>

  <div class="card shadow-sm mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Add New Ticket Stock</h6>
    </div>
    <div class="card-body">
      <form action="/ticketing/stock/add" method="POST" class="row g-3 align-items-end mb-4">
        <div class="col-md-3">
          <label for="rate" class="form-label">Ticket Rate</label>
          <select id="base_rate_id" name="base_rate_id" class="form-select" required>
            <option value="" disabled selected>Choose rate...</option>
            <% baseRates.forEach(rate => { %>
              <option value="<%= rate.id %>"><%= rate.rate %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-3">
          <label for="color" class="form-label">Ticket Color</label>
          <select id="color" name="color" class="form-select" required>
            <option value="" disabled selected>Choose color...</option>
            <option value="Red">Red</option>
            <option value="Green">Green</option>
            <option value="Blue">Blue</option>
            <option value="Yellow">Yellow</option>
            <option value="Pink">Pink</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="start_number" class="form-label">Starting Serial Number</label>
          <input type="number" class="form-control" id="start_number" name="start_number" required>
        </div>
        <div class="col-md-2">
          <label for="end_number" class="form-label">Ending Serial Number</label>
          <input type="number" class="form-control" id="end_number" name="end_number" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
    </div>
    <div class="card-footer bg-light">
      <a href="/ticketing/stock/bulk-upload" class="btn btn-sm btn-outline-primary"><i class="bi bi-upload me-1"></i>Bulk Upload from CSV</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header py-3"><h6 class="m-0 fw-bold text-primary">Ticket Stock History</h6></div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered" id="dataTable">
          <thead>
            <tr>
              <th>Ticket Rate</th>
              <th>Color</th>
              <th>Start Number</th>
              <th>End Number</th>
              <th>Total Tickets</th>
              <th>Status</th>
              <th>Date Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% stock.forEach(item => { %>
              <tr>
                <td>â‚¹<%= item.rate %></td>
                <td><span class="badge" style="background-color: <%= item.color ? item.color.toLowerCase() : 'grey' %>;"><%= item.color %></span></td>
                <td><%= item.start_number %></td>
                <td><%= item.end_number %></td>
                <td><%= item.end_number - item.start_number + 1 %></td>
                <td>
                  <span class="badge bg-<%= item.status === 'Available' ? 'success' : (item.status === 'Distributed' ? 'warning' : 'secondary') %>"><%= item.status %></span>
                </td>
                <td><%= new Date(item.created_at).toLocaleString() %></td>
                <td>
                  <% if (item.status === 'Available') { %>
                    <a href="/ticketing/stock/edit/<%= item.id %>" class="btn btn-sm btn-warning me-1" title="Edit"><i class="bi bi-pencil"></i></a>
                    <form action="/ticketing/stock/delete/<%= item.id %>" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this stock entry?');">
                      <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card border-danger shadow-sm mt-4">
  <div class="card-header bg-danger text-white">
    <h6 class="m-0 fw-bold">Danger Zone</h6>
  </div>
  <div class="card-body">
    <h5 class="card-title">Clear All Ticket History</h5>
    <p class="card-text">This will permanently delete all ticket stock, all ticket distributions, and all related sales records from accounting. This action cannot be undone.</p>
    <form action="/ticketing/stock/clear-all" method="POST" onsubmit="return confirm('Are you absolutely sure? This will delete all ticketing history permanently.');">
      <button type="submit" class="btn btn-danger">Clear All Stock & Sales History</button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('base_rate_id').focus();
  });
</script>

<%- include('partials/footer') %>
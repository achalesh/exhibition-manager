<%- include('partials/header') %>

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0"><%= title %></h1>
            <a href="/dashboard" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
        <div class="card-body">
            <form action="/material/issue" method="POST" id="materialIssueForm">
                <div class="row g-3">
                    <!-- Client and Stall Info -->
                    <div class="col-md-4">
                        <label for="client_id" class="form-label">Client</label>
                        <select name="client_id" id="client_id" class="form-select" required>
                            <option value="">Select Client</option>
                            <% clients.forEach(client => { %>
                                <option value="<%= client.client_id %>" <%= selectedClientId == client.client_id ? 'selected' : '' %>>
                                    <%= client.client_name %> (<%= client.facia_name %> - <%= client.space_name %>)
                                </option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="sl_no" class="form-label">SL No.</label>
                        <input type="text" class="form-control" id="sl_no" name="sl_no">
                    </div>
                    <div class="col-md-3">
                        <label for="stall_number" class="form-label">Stall Number</label>
                        <input type="text" class="form-control" id="stall_number" name="stall_number">
                    </div>
                    <div class="col-md-3">
                        <label for="camp" class="form-label">Camp</label>
                        <input type="text" class="form-control" id="camp" name="camp" list="camp-suggestions">
                        <datalist id="camp-suggestions">
                            <% suggestions.camps.forEach(camp => { %>
                                <option value="<%= camp %>">
                            <% }) %>
                        </datalist>
                    </div>

                    <!-- Free Items -->
                    <h5 class="mt-4">Free Items</h5>
                    <div class="col-md-3">
                        <label for="plywood_free" class="form-label">Plywood</label>
                        <input type="number" class="form-control" id="plywood_free" name="plywood_free" value="<%= suggestions.defaults.plywood_free || 0 %>">
                    </div>
                    <div class="col-md-3">
                        <label for="table_free" class="form-label">Tables</label>
                        <input type="number" class="form-control" id="table_free" name="table_free" value="<%= suggestions.defaults.table_free || 0 %>">
                    </div>
                    <div class="col-md-3">
                        <label for="chair_free" class="form-label">Chairs</label>
                        <input type="number" class="form-control" id="chair_free" name="chair_free" value="<%= suggestions.defaults.chair_free || 0 %>">
                    </div>
                    <div class="col-md-3">
                        <label for="rod_free" class="form-label">Rods</label>
                        <input type="number" class="form-control" id="rod_free" name="rod_free" value="<%= suggestions.defaults.rod_free || 0 %>">
                    </div>

                    <!-- Paid Items -->
                    <h5 class="mt-4">Paid Items</h5>
                    <div class="col-md-4">
                        <label for="plywood_paid" class="form-label">Plywood (₹<span id="plywood_rate_display">300</span>)</label>
                        <input type="number" class="form-control paid-item" id="plywood_paid" name="plywood_paid" value="0" data-rate="300">
                    </div>
                    <div class="col-md-4">
                        <label for="table_paid" class="form-label">Tables (₹<span id="table_rate_display">600</span>)</label>
                        <input type="number" class="form-control paid-item" id="table_paid" name="table_paid" value="0" data-rate="600">
                    </div>
                    <div class="col-md-4">
                        <label for="chair_paid" class="form-label">Chairs (₹<span id="chair_rate_display">100</span>)</label>
                        <input type="number" class="form-control paid-item" id="chair_paid" name="chair_paid" value="0" data-rate="100">
                    </div>

                    <!-- Item Numbers -->
                    <h5 class="mt-4">Item Numbers</h5>
                    <div class="col-md-6">
                        <label for="table_numbers" class="form-label">Table Numbers</label>
                        <input type="text" class="form-control" id="table_numbers" name="table_numbers">
                    </div>
                    <div class="col-md-6">
                        <label for="chair_numbers" class="form-label">Chair Numbers</label>
                        <input type="text" class="form-control" id="chair_numbers" name="chair_numbers">
                    </div>

                    <!-- Financials -->
                    <h5 class="mt-4">Financials</h5>
                    <div class="col-md-4">
                        <label for="total_payable" class="form-label">Total Payable</label>
                        <input type="number" class="form-control" id="total_payable" name="total_payable" value="0" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="advance_paid" class="form-label">Advance Paid</label>
                        <input type="number" class="form-control" id="advance_paid" name="advance_paid" value="0">
                    </div>
                    <div class="col-md-4">
                        <label for="balance_due" class="form-label">Balance Due</label>
                        <input type="number" class="form-control" id="balance_due" name="balance_due" value="0" readonly>
                    </div>

                    <!-- Notes and Date -->
                    <div class="col-md-6">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="issue_date" class="form-label">Issue Date</label>
                        <input type="date" class="form-control" id="issue_date" name="issue_date" value="<%= new Date().toISOString().split('T')[0] %>" required>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Issue Materials</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('materialIssueForm');
    const clientIdSelect = document.getElementById('client_id');
    const plywoodFreeInput = document.getElementById('plywood_free');
    const tableFreeInput = document.getElementById('table_free');
    const chairFreeInput = document.getElementById('chair_free');
    const rodFreeInput = document.getElementById('rod_free');

    const paidItems = form.querySelectorAll('.paid-item');
    const totalPayableInput = document.getElementById('total_payable');
    const advancePaidInput = document.getElementById('advance_paid');
    const balanceDueInput = document.getElementById('balance_due');

    // Function to update the rate display spans (copied from editMaterial.ejs)
    function updateRateDisplays() {
        paidItems.forEach(item => {
            const rate = item.dataset.rate;
            const displayId = `${item.id.replace('_paid', '')}_rate_display`;
            const displaySpan = document.getElementById(displayId);
            if (displaySpan) {
                displaySpan.textContent = rate;
            }
        });
    }

    // Function to calculate and update totals (copied from editMaterial.ejs)
    function updateTotals() {
        let totalPayable = 0;
        paidItems.forEach(item => {
            const quantity = parseInt(item.value, 10) || 0;
            const rate = parseFloat(item.dataset.rate) || 0;
            totalPayable += quantity * rate;
        });

        const advancePaid = parseFloat(advancePaidInput.value) || 0;
        const balanceDue = totalPayable - advancePaid;

        totalPayableInput.value = totalPayable.toFixed(2);
        balanceDueInput.value = balanceDue.toFixed(2);
    }

    // Event listener for client selection change
    clientIdSelect.addEventListener('change', async function() {
        const clientId = this.value;
        if (clientId) {
            try {
                const response = await fetch(`/material/api/get-client-free-item-defaults/${clientId}`);
                const defaults = await response.json();

                if (defaults) {
                    plywoodFreeInput.value = defaults.plywood_free;
                    tableFreeInput.value = defaults.table_free;
                    chairFreeInput.value = defaults.chair_free;
                    rodFreeInput.value = defaults.rod_free;
                }
            } catch (error) {
                console.error('Error fetching client defaults:', error);
                // Optionally, reset to global defaults or show an error message
            }
        } else {
            // If no client is selected, reset to global defaults (or 0)
            plywoodFreeInput.value = <%= suggestions.defaults.plywood_free || 0 %>;
            tableFreeInput.value = <%= suggestions.defaults.table_free || 0 %>;
            chairFreeInput.value = <%= suggestions.defaults.chair_free || 0 %>;
            rodFreeInput.value = <%= suggestions.defaults.rod_free || 0 %>;
        }
    });

    // Add event listeners to all paid item inputs and the advance paid input
    paidItems.forEach(item => {
        item.addEventListener('input', updateTotals);
    });
    advancePaidInput.addEventListener('input', updateTotals);

    // Initial setup
    updateRateDisplays();
    updateTotals(); // Calculate totals on page load

    // Trigger change event if a client is already selected on page load (e.g., from query param)
    if (clientIdSelect.value) {
        clientIdSelect.dispatchEvent(new Event('change'));
    }
});
</script>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2><%= title %></h2>
      <a href="/settings/materials" class="btn btn-sm btn-outline-secondary">Edit Defaults</a>
    </div>
    <div class="card-body">
      <form action="/material/issue" method="POST">
        
        <!-- Client and Stall Info -->
        <div class="row mb-3">
          <div class="col-md-5">
            <label for="client_id" class="form-label">Select Exhibitor</label>
            <select class="form-select" id="client_id" name="client_id" required>
              <option value="" selected disabled>-- Choose an Exhibitor --</option>
              <% clients.forEach(client => { %>
                <option value="<%= client.client_id %>" 
                        data-space-name="<%= client.space_name %>"
                        <%= selectedClientId == client.client_id ? 'selected' : '' %>>
                  <%= client.client_name %> <% if (client.facia_name) { %>(<%= client.facia_name %>) <% } %>- [<%= client.space_name %>]
                </option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2">
            <label for="sl_no" class="form-label">Sl.No.</label>
            <input type="text" class="form-control" id="sl_no" name="sl_no">
          </div>
          <div class="col-md-2">
            <label for="stall_number" class="form-label">Stall Number</label>
            <input type="text" class="form-control" id="stall_number" name="stall_number" readonly>
          </div>
          <div class="col-md-3 ">
            <label for="camp" class="form-label">Camp</label>
            <input type="text" class="form-control" id="camp" name="camp" list="camp-suggestions">
            <datalist id="camp-suggestions">
              <% suggestions.camps.forEach(item => { %>
                <option value="<%= item %>">
              <% }) %>
            </datalist>
          </div>
        </div>

        <hr>

        <!-- Free Materials -->
        <h5 class="mt-4">Materials Provided (Free of Cost)</h5>
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="plywood_free" class="form-label">Octonorm Plywood</label>
            <input type="number" class="form-control" id="plywood_free" name="plywood_free" value="0" min="0">
          </div>
          <div class="col-md-3">
            <label for="table_free" class="form-label">Tables</label>
            <input type="number" class="form-control" id="table_free" name="table_free" value="<%= suggestions.defaults.free_tables %>" min="0">
          </div>
          <div class="col-md-3">
            <label for="chair_free" class="form-label">Chairs</label>
            <input type="number" class="form-control" id="chair_free" name="chair_free" value="<%= suggestions.defaults.free_chairs %>" min="0">
          </div>
          <div class="col-md-3">
            <label for="rod_free" class="form-label">Extra Rod</label>
            <input type="number" class="form-control" id="rod_free" name="rod_free" value="0" min="0">
          </div>
        </div>

        <hr>

        <!-- Chargeable Materials -->
        <h5 class="mt-4">Materials Provided (Chargeable Basis)</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="plywood_paid" class="form-label">Octonorm Plywood (₹600/pc)</label>
            <input type="number" class="form-control chargeable" id="plywood_paid" name="plywood_paid" value="0" min="0" data-rate="600">
          </div>
          <div class="col-md-4">
            <label for="table_paid" class="form-label">Tables (₹600/table)</label>
            <input type="number" class="form-control chargeable" id="table_paid" name="table_paid" value="0" min="0" data-rate="600">
          </div>
          <div class="col-md-4">
            <label for="chair_paid" class="form-label">Chairs (₹100/chair)</label>
            <input type="number" class="form-control chargeable" id="chair_paid" name="chair_paid" value="0" min="0" data-rate="100">
          </div>
        </div>

        <hr>

        <!-- Asset Details -->
        <h5 class="mt-4">Asset Details</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="table_numbers" class="form-label">Provided Table Numbers</label>
            <input type="text" class="form-control" id="table_numbers" name="table_numbers" placeholder="e.g., T-01, T-05, T-12">
          </div>
          <div class="col-md-6">
            <label for="chair_numbers" class="form-label">Provided Chair Numbers</label>
            <input type="text" class="form-control" id="chair_numbers" name="chair_numbers" placeholder="e.g., C-01, C-02, C-08">
          </div>
        </div>

        <hr>

        <!-- Calculation -->
        <h5 class="mt-4">Payment Calculation</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="total_payable" class="form-label">Total Payable (₹)</label>
            <input type="number" class="form-control" id="total_payable" name="total_payable" readonly>
          </div>
          <div class="col-md-4">
            <label for="advance_paid" class="form-label">Less: Advance (₹)</label>
            <input type="number" class="form-control" id="advance_paid" name="advance_paid" value="0" min="0">
          </div>
          <div class="col-md-4">
            <label for="balance_due" class="form-label">Balance Payable (₹)</label>
            <input type="number" class="form-control" id="balance_due" name="balance_due" readonly>
          </div>
        </div>

        <!-- Notes -->
        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Issue Materials</button>
        <a href="/" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('client_id');
    const stallNumberInput = document.getElementById('stall_number');
    const tableFreeInput = document.getElementById('table_free');
    const chairFreeInput = document.getElementById('chair_free');
    
    clientSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const spaceName = selectedOption.getAttribute('data-space-name');
      stallNumberInput.value = spaceName;
    });

    // Calculate totals on input change
    const allInputs = [plywoodPaidInput, tablePaidInput, chairPaidInput, advanceInput];
    allInputs.forEach(input => {
      input.addEventListener('input', calculateTotals);
    });
    
    const plywoodPaidInput = document.getElementById('plywood_paid');
    const tablePaidInput = document.getElementById('table_paid');
    const chairPaidInput = document.getElementById('chair_paid');
    const advanceInput = document.getElementById('advance_paid');

    function calculateTotals() {
      // Calculate total for paid items
      let total = 0;
      document.querySelectorAll('.chargeable').forEach(item => {
        const quantity = parseInt(item.value, 10) || 0;
        const rate = parseFloat(item.getAttribute('data-rate')) || 0;
        total += quantity * rate;
      });
      const totalPayableInput = document.getElementById('total_payable');
      totalPayableInput.value = total;

      // Calculate balance due
      const advance = parseFloat(advanceInput.value) || 0;
      const balance = total - advance;
      const balanceDueInput = document.getElementById('balance_due');
      balanceDueInput.value = balance;
    }

    // Initial calculation on page load
    calculateTotals();
  });
</script>

<%- include('partials/footer') %>
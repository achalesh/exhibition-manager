<%- include('partials/header') %>

<div class="container-fluid">
  <h1 class="h3 mb-4 text-gray-800"><%= title %></h1>

  <% if (lastPaymentId) { %>
    <div class="alert alert-success d-flex justify-content-between align-items-center">
      <span>Payment recorded successfully!</span>
      <a href="/charges/receipt/<%= lastPaymentId %>" target="_blank" class="btn btn-sm btn-outline-success">
        <i class="bi bi-printer-fill me-1"></i> Print Last Receipt
      </a>
    </div>
  <% } %>

  <div class="card shadow-sm">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Payment Details</h6>
    </div>
    <div class="card-body">
      <form action="/charges/add" method="POST">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="booking_id" class="form-label">Exhibitor <span class="text-danger">*</span></label>
            <select id="booking_id" name="booking_id" class="form-select" required autofocus>
              <option value="">-- Select Exhibitor --</option>
              <% bookings.forEach(b => { %>
                <option value="<%= b.id %>" data-facia-name="<%= b.facia_name || '' %>"><%= b.exhibitor_name %> (<%= b.space_name %>)</option>
              <% }) %>
            </select>
            <div id="facia-name-display" class="form-text text-muted fw-bold"></div>
          </div>
          <div class="col-md-6">
            <label for="receipt_number" class="form-label">Receipt Number</label>
            <input type="text" class="form-control" id="receipt_number" name="receipt_number" value="<%= nextReceiptNumber %>">
          </div>
          <div class="col-md-6">
            <label for="payment_date" class="form-label">Payment Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="payment_date" name="payment_date" value="<%= new Date().toISOString().split('T')[0] %>" required>
          </div>
          <div class="col-md-6">
            <label for="payment_type" class="form-label">Payment For <span class="text-danger">*</span></label>
            <select id="payment_type" name="payment_type" class="form-select" required>
              <option value="rent">Rent</option>
              <option value="electric">Electric</option>
              <option value="material">Material</option>
              <option value="shed">Shed</option>
            </select>
          </div>
          <div class="col-md-6">
            <label for="cash_paid" class="form-label">Cash Amount Paid</label>
            <input type="number" step="0.01" class="form-control" id="cash_paid" name="cash_paid" placeholder="0.00">
          </div>
          <div class="col-md-6">
            <label for="upi_paid" class="form-label">UPI Amount Paid</label>
            <input type="number" step="0.01" class="form-control" id="upi_paid" name="upi_paid" placeholder="0.00">
          </div>
        </div>

        <!-- Due Details Display -->
        <div id="due-details" class="mt-4 p-3 bg-light rounded" style="display: none;">
          <h5>Due Summary</h5>
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">Rent Due: <span id="rent-due" class="badge bg-primary rounded-pill"></span></li>
            <li class="list-group-item d-flex justify-content-between align-items-center">Electric Due: <span id="electric-due" class="badge bg-primary rounded-pill"></span></li>
            <li class="list-group-item d-flex justify-content-between align-items-center">Material Due: <span id="material-due" class="badge bg-primary rounded-pill"></span></li>
            <li class="list-group-item d-flex justify-content-between align-items-center">Shed Due: <span id="shed-due" class="badge bg-primary rounded-pill"></span></li>
            <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">Total Due: <span id="total-due" class="badge bg-danger rounded-pill fs-6"></span></li>
          </ul>
        </div>

        <button type="submit" class="btn btn-success mt-4">Record Payment</button>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const bookingSelect = document.getElementById('booking_id');
    const dueDetailsDiv = document.getElementById('due-details');
    const faciaDisplay = document.getElementById('facia-name-display');

    async function fetchDueDetails(bookingId) {
      if (!bookingId) {
        dueDetailsDiv.style.display = 'none';
        faciaDisplay.textContent = '';
        return;
      }

      // Display Facia Name
      const selectedOption = bookingSelect.options[bookingSelect.selectedIndex];
      const faciaName = selectedOption.dataset.faciaName;
      faciaDisplay.textContent = faciaName ? `Facia: ${faciaName}` : '';

      try {
        const response = await fetch(`/charges/details/${bookingId}`);
        if (!response.ok) throw new Error('Network response was not ok.');
        const data = await response.json();

        document.getElementById('rent-due').textContent = `₹${data.rent_due.toFixed(2)}`;
        document.getElementById('electric-due').textContent = `₹${data.electric_due.toFixed(2)}`;
        document.getElementById('material-due').textContent = `₹${data.material_due.toFixed(2)}`;
        document.getElementById('shed-due').textContent = `₹${data.shed_due.toFixed(2)}`;
        document.getElementById('total-due').textContent = `₹${data.total_due.toFixed(2)}`;

        dueDetailsDiv.style.display = 'block';
      } catch (error) {
        console.error('Failed to fetch due details:', error);
        dueDetailsDiv.style.display = 'none';
      }
    }

    bookingSelect.addEventListener('change', function() {
      fetchDueDetails(this.value);
    });

    // On page load, check if a booking is already selected (e.g., after a redirect)
    const urlParams = new URLSearchParams(window.location.search);
    const bookingIdFromUrl = urlParams.get('booking_id');
    if (bookingIdFromUrl) {
      bookingSelect.value = bookingIdFromUrl;
      fetchDueDetails(bookingIdFromUrl);
    }
  });
</script>

<%- include('partials/footer') %>
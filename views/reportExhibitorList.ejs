<%- include('partials/header') %>

<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-md-6">
                <h3 class="mb-0">Exhibitor List Report</h3>
            </div>
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Search exhibitors...">
            </div>
            <div class="col-md-2 text-end">
                <button onclick="window.print()" class="btn btn-primary d-print-none me-1" title="Print Report"><i class="fas fa-print"></i> Print</button>
                <button id="download-excel" class="btn btn-success d-print-none" title="Download Excel"><i class="fas fa-file-excel"></i> Excel</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="reportTable" class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th data-sort-dir="asc"># <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Exhibitor Name <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Facia Name <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Contact Person <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Contact Number <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Address <i class="fas fa-sort"></i></th>
                        <th data-sort-dir="asc">Space <i class="fas fa-sort"></i></th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <% if (exhibitors && exhibitors.length > 0) { %>
                        <% exhibitors.forEach((ex, index) => { %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td><%= ex.exhibitor_name %></td>
                                <td><%= ex.facia_name %></td>
                                <td><%= ex.contact_person %></td>
                                <td><%= ex.contact_number %> <%= ex.secondary_number ? ', ' + ex.secondary_number : '' %></td>
                                <td><%= ex.full_address %></td>
                                <td><%= ex.space_name %></td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="7" class="text-center">No exhibitors found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer d-flex justify-content-between align-items-center d-print-none">
        <div>
            <select id="rowsPerPage" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <span id="pagination-info" class="ms-2 text-muted"></span>
        </div>
        <nav>
            <ul id="pagination" class="pagination pagination-sm mb-0"></ul>
        </nav>
    </div>
</div>

<script>
    document.getElementById('download-excel').addEventListener('click', function() {
        window.location.href = '/report/downloadExcelExhibitors';
    });

    const table = document.getElementById('reportTable');
    const tableBody = document.getElementById('reportTableBody');
    const allRows = Array.from(tableBody.querySelectorAll('tr'));
    table.querySelectorAll('thead th').forEach((header, colIndex) => {
        header.addEventListener('click', () => {
            const sortDir = header.dataset.sortDir;
            const newSortDir = sortDir === 'asc' ? 'desc' : 'asc';
            header.dataset.sortDir = newSortDir;

            table.querySelectorAll('thead th i').forEach(i => i.className = 'fas fa-sort');
            header.querySelector('i').className = newSortDir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';

            const rows = Array.from(allRows);

            rows.sort((a, b) => {
                let valA = a.cells[colIndex].textContent.trim();
                let valB = b.cells[colIndex].textContent.trim();

                if (!isNaN(valA.replace(/[^0-9.-]/g, '')) && !isNaN(valB.replace(/[^0-9.-]/g, ''))) {
                    valA = parseFloat(valA.replace(/[^0-9.-]/g, ''));
                    valB = parseFloat(valB.replace(/[^0-9.-]/g, ''));
                } else {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                return (valA < valB ? -1 : (valA > valB ? 1 : 0)) * (newSortDir === 'asc' ? 1 : -1);
            });

            allRows.splice(0, allRows.length, ...rows);
            renderTable();
        });
    });

    // --- Pagination and Search ---
    const searchInput = document.getElementById('searchInput');
    const rowsPerPageSelect = document.getElementById('rowsPerPage');
    const paginationContainer = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');

    let currentPage = 1;
    let rowsPerPage = parseInt(rowsPerPageSelect.value, 10);
    let filteredRows = [...allRows];

    function renderTable() {
        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = filteredRows.slice(start, end);

        paginatedRows.forEach(row => tableBody.appendChild(row));

        setupPagination();
        updatePaginationInfo();
    }

    function setupPagination() {
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(filteredRows.length / rowsPerPage);

        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
        paginationContainer.appendChild(prevLi);

        for (let i = 1; i <= pageCount; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
            paginationContainer.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === pageCount ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
        paginationContainer.appendChild(nextLi);
    }

    function updatePaginationInfo() {
        const start = Math.min((currentPage - 1) * rowsPerPage + 1, filteredRows.length);
        const end = Math.min(start + rowsPerPage - 1, filteredRows.length);
        paginationInfo.textContent = `Showing ${start} to ${end} of ${filteredRows.length} entries`;
    }

    searchInput.addEventListener('keyup', () => {
        const searchTerm = searchInput.value.toLowerCase();
        filteredRows = allRows.filter(row => row.textContent.toLowerCase().includes(searchTerm));
        currentPage = 1;
        renderTable();
    });

    rowsPerPageSelect.addEventListener('change', () => {
        rowsPerPage = parseInt(rowsPerPageSelect.value, 10);
        currentPage = 1;
        renderTable();
    });

    paginationContainer.addEventListener('click', e => {
        if (e.target.tagName === 'A' && e.target.dataset.page) {
            e.preventDefault();
            const page = parseInt(e.target.dataset.page, 10);
            if (page > 0 && page <= Math.ceil(filteredRows.length / rowsPerPage)) {
                currentPage = page;
                renderTable();
            }
        }
    });

    renderTable();
</script>

<%- include('partials/footer') %>
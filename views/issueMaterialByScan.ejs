<%- include('partials/header') %>

<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><%= title %></h4>
        </div>
        <div class="card-body">
          <p class="text-muted">Select a client, then scan a material's QR code or enter its Unique ID to issue the item.</p>

          <!-- Client Selection -->
          <div class="mb-3">
            <label for="clientId" class="form-label">Client / Exhibitor</label>
            <select id="clientId" class="form-select" required>
              <option value="" disabled <%= !selectedClientId ? 'selected' : '' %>>-- Select a Client --</option>
              <% clients.forEach(client => { %>
                <option value="<%= client.id %>" <%= selectedClientId == client.id ? 'selected' : '' %>><%= client.name %> (<%= client.space_name %>)</option>
              <% }) %>
            </select>
          </div>

          <!-- QR Code Scanner Section -->
          <div id="reader" style="width: 100%;" class="mb-3"></div>
          <button id="start-scan-btn" class="btn btn-outline-primary w-100 mb-3"><i class="bi bi-qr-code-scan me-2"></i>Start Camera Scan</button>
          <button id="stop-scan-btn" class="btn btn-outline-secondary w-100 mb-3" style="display: none;"><i class="bi bi-camera-video-off me-2"></i>Stop Scanning</button>

          <hr>

          <!-- Manual Entry -->
          <div class="mb-3">
            <label for="uniqueId" class="form-label">Material Unique ID</label>
            <input type="text" class="form-control" id="uniqueId" placeholder="e.g., NCF/T/BLR/0001" autofocus>
          </div>

          <div class="d-grid">
            <button id="issue-btn" class="btn btn-success"><i class="bi bi-box-arrow-up-right me-2"></i>Issue Material</button>
          </div>

          <div id="result-message" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientIdSelect = document.getElementById('clientId');
    const uniqueIdInput = document.getElementById('uniqueId');
    const issueBtn = document.getElementById('issue-btn');
    const resultMessage = document.getElementById('result-message');
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    const readerDiv = document.getElementById('reader');

    async function handleIssue() {
        const uniqueId = uniqueIdInput.value.trim();
        const clientId = clientIdSelect.value;

        if (!clientId) return showMessage('Please select a client.', 'warning');
        if (!uniqueId) return showMessage('Please enter or scan a Unique ID.', 'warning');

        issueBtn.disabled = true;

        try {
            const response = await fetch('/materials/api/issue-item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uniqueId, clientId }),
            });
            const result = await response.json();
            showMessage(result.message, result.success ? 'success' : 'danger');
            if (result.success) uniqueIdInput.value = '';
        } catch (error) {
            showMessage('A network error occurred. Please try again.', 'danger');
        } finally {
            issueBtn.disabled = false;
            uniqueIdInput.focus();
        }
    }

    function showMessage(message, type) {
        resultMessage.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
        setTimeout(() => { resultMessage.innerHTML = ''; }, 5000);
    }

    const html5QrCode = new Html5Qrcode("reader");
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        uniqueIdInput.value = decodedText;
        stopScanning();
        handleIssue(); // Automatically issue after a successful scan
    };
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    function startScanning() {
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .then(() => {
                startScanBtn.style.display = 'none';
                stopScanBtn.style.display = 'block';
                readerDiv.style.border = '1px solid #dee2e6';
            }).catch(err => showMessage('Could not start camera. Please grant permission.', 'danger'));
    }

    function stopScanning() {
        html5QrCode.stop().then(() => {
            startScanBtn.style.display = 'block';
            stopScanBtn.style.display = 'none';
            readerDiv.style.border = 'none';
        }).catch(err => {});
    }

    issueBtn.addEventListener('click', handleIssue);
    startScanBtn.addEventListener('click', startScanning);
    stopScanBtn.addEventListener('click', stopScanning);
});
</script>

<%- include('partials/footer') %>
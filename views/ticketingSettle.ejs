<%- include('partials/header') %>

<div class="container mt-4">
    <%- include('partials/ticketingSubNav') %>

    <div class="card mx-auto" style="max-width: 700px;">
        <div class="card-header">
            <h1 class="h3 mb-0"><%= title %></h1>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <p><strong>Staff:</strong> <%= dist.staff_name %></p>
                    <p><strong>Ride:</strong> <%= dist.ride_name %></p>
                    <p><strong>Distribution Date:</strong> <%= new Date(dist.distribution_date).toLocaleDateString('en-GB') %></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Ticket Book:</strong> #<%= dist.distributed_start_number %> to #<%= dist.distributed_end_number %></p>
                    <p><strong>Rate:</strong> â‚¹<%= dist.ticket_rate.toFixed(2) %></p>
                    <p><strong>Total Tickets:</strong> <%= dist.distributed_end_number - dist.distributed_start_number + 1 %></p>
                </div>
            </div>

            <hr>

            <form 
                action="/ticketing/settle/<%= dist.id %>" 
                method="POST" 
                id="settleForm"
                data-ticket-rate="<%= dist.ticket_rate %>"
                data-start-number="<%= dist.distributed_start_number %>">
                <div class="mb-3">
                    <label for="returned_start_number" class="form-label">Returned Start Number (Next Unused Ticket)</label>
                    <input type="number" class="form-control" id="returned_start_number" name="returned_start_number" value="<%= dist.distributed_start_number %>" min="<%= dist.distributed_start_number %>" max="<%= dist.distributed_end_number + 1 %>" required autofocus>
                    <div class="form-text">Enter the number of the first ticket that was NOT sold.</div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="tickets_sold" class="form-label">Tickets Sold</label>
                        <input type="text" class="form-control" id="tickets_sold" readonly>
                    </div>
                    <div class="col-md-6">
                        <label for="expected_revenue" class="form-label">Expected Revenue</label>
                        <input type="text" class="form-control" id="expected_revenue" readonly>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cash_amount" class="form-label">Cash Amount Received</label>
                        <input type="number" class="form-control" id="cash_amount" name="cash_amount" step="0.01" value="0" required>
                    </div>
                    <div class="col-md-6">
                        <label for="upi_amount" class="form-label">UPI Amount Received</label>
                        <input type="number" class="form-control" id="upi_amount" name="upi_amount" step="0.01" value="0" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="settlement_date" class="form-label">Settlement Date</label>
                    <input type="date" class="form-control" id="settlement_date" name="settlement_date" value="<%= new Date().toISOString().split('T')[0] %>" required>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes (for Shortage/Excess)</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                </div>

                <div class="d-flex justify-content-end">
                    <a href="/ticketing/distribute" class="btn btn-secondary me-2">Cancel</a>
                    <button type="submit" class="btn btn-primary">Settle Account</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/js/ticketingSettle.js"></script>

<%- include('partials/footer') %>
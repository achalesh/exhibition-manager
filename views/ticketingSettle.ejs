<%- include('partials/header') %>

<div class="container-fluid">
  <%- include('partials/ticketingNav') %>

    <!-- Filter Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="GET" action="/ticketing/settle" class="row g-3 align-items-end">
        <div class="col-md-10">
          <label for="q" class="form-label">Search by Staff or Ride Name</label>
          <input type="text" class="form-control" id="q" name="q" value="<%= filters.q %>" placeholder="e.g., John Doe or Ferris Wheel...">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Unsettled Distributions -->
  <div class="card shadow-sm mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Unsettled Ticket Bundles</h6>
    </div>
    <div class="card-body">
      <% if (distributions && distributions.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-bordered" width="100%" cellspacing="0">
            <thead>
              <tr>
                <th>Distributed On</th>
                <th>Staff Member</th>
                <th>Ride Name</th>
                <th>Ticket Bundle</th>
                <th class="text-center">Rate (₹)</th>
                <th>Returned Start No.</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% distributions.forEach((dist, index) => { %>
                <form action="/ticketing/settle/confirm/<%= dist.id %>" method="GET">
                  <tr>
                    <td><%= new Date(dist.distribution_date).toLocaleDateString('en-IN') %></td>
                    <td><%= dist.staff_name %></td>
                    <td><%= dist.ride_name %></td>
                    <td><%= dist.distributed_start_number %> - <%= dist.distributed_end_number %></td>
                    <td class="text-center"><%= dist.rate.toFixed(2) %></td>
                    <td>
                      <input type="number" name="returned_start_number" class="form-control form-control-sm" min="<%= dist.distributed_start_number %>" max="<%= dist.distributed_end_number + 1 %>" required <%= index === 0 ? 'autofocus' : '' %>>
                    </td>
                    <td>
                      <button type="submit" class="btn btn-sm btn-primary">Settle</button>
                    </td>
                  </tr>
                </form>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div class="alert alert-info">There are no unsettled ticket bundles at this time.</div>
      <% } %>
    </div>
  </div>

  <!-- Recently Settled Distributions -->
  <div class="card shadow-sm">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Recently Settled (Last 10)</h6>
    </div>
    <div class="card-body">
      <% if (settledDistributions && settledDistributions.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-bordered table-striped" width="100%" cellspacing="0">
            <thead class="table-light">
              <tr>
                <th>Settled On</th>
                <th>Staff Member</th>
                <th>Ride Name</th>
                <th class="text-end">Tickets Sold</th>
                <th class="text-end">Revenue (₹)</th>
                <th>Settled By</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% settledDistributions.forEach(dist => { %>
                <tr>
                  <td><%= new Date(dist.settlement_date).toLocaleDateString('en-IN') %></td>
                  <td><%= dist.staff_name %></td>
                  <td><%= dist.ride_name %></td>
                  <td class="text-end"><%= dist.tickets_sold %></td>
                  <td class="text-end"><%= dist.calculated_revenue.toFixed(2) %></td>
                  <td><%= dist.settled_by %></td>
                  <td>
                    <% if (dist.stock_id) { %>
                      <form action="/ticketing/unsettle/<%= dist.id %>" method="POST" onsubmit="return confirm('Are you sure you want to reverse this settlement? This will remove the accounting entry and mark the bundle as unsettled again.');">
                        <button type="submit" class="btn btn-sm btn-outline-warning" title="Reverse Settlement">
                          <i class="bi bi-arrow-counterclockwise"></i> Reverse
                        </button>
                      </form>
                    <% } else { %>
                      <a href="/ticketing/import/edit/<%= dist.id %>" class="btn btn-sm btn-outline-primary" title="Edit Imported Sale">
                        <i class="bi bi-pencil"></i> Edit
                      </a>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } else { %>
        <div class="alert alert-secondary">No settled distributions to show yet.</div>
      <% } %>
    </div>
  </div>

  <!-- Staff Cash Settlement -->
  <div class="card shadow-sm mt-4">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Settle Staff Cash (Short/Excess)</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-lg-8">
          <form action="/ticketing/cash-settle" method="POST" id="cashSettleForm">
            <div class="row g-3 align-items-end">
              <div class="col-md-4">
                <label for="staff_id" class="form-label">Staff Member</label>
                <select id="staff_id" name="staff_id" class="form-select" required>
                  <option value="" selected disabled>Select Staff...</option>
                  <% staffList.forEach(staff => { %>
                    <option value="<%= staff.id %>"><%= staff.name %></option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4">
                <label for="expected_amount" class="form-label">Expected Cash Amount (₹)</label>
                <div class="input-group">
                  <input type="number" step="0.01" class="form-control" id="expected_amount" name="expected_amount" required readonly>
                  <button class="btn btn-outline-secondary" type="button" id="fetchExpected">Fetch</button>
                </div>
              </div>
              <div class="col-md-4">
                <label for="actual_amount" class="form-label">Actual Cash Received (₹)</label>
                <input type="number" step="0.01" class="form-control" id="actual_amount" name="actual_amount" required>
              </div>
              <div class="col-md-8">
                <label for="notes" class="form-label">Notes (Optional)</label>
                <input type="text" class="form-control" id="notes" name="notes" placeholder="e.g., Paid from personal funds">
              </div>
              <div class="col-md-4">
                <button type="submit" class="btn btn-success w-100">Record Settlement</button>
              </div>
            </div>
          </form>
          <div id="difference" class="mt-3 fs-5 fw-bold"></div>
        </div>
        <div class="col-lg-4">
          <h6>Unsettled Balances</h6>
          <% if (unsettledTotals && unsettledTotals.length > 0) { %>
            <ul class="list-group">
              <% unsettledTotals.forEach(item => { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <%= item.name %>
                  <span class="badge <%= item.total_unsettled < 0 ? 'bg-danger' : 'bg-warning text-dark' %> rounded-pill">
                    <%= item.total_unsettled.toFixed(2) %>
                  </span>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-muted">No outstanding cash balances.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

</div>

<%- include('partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const staffSelect = document.getElementById('staff_id');
    const fetchBtn = document.getElementById('fetchExpected');
    const expectedInput = document.getElementById('expected_amount');
    const actualInput = document.getElementById('actual_amount');
    const differenceDiv = document.getElementById('difference');

    fetchBtn.addEventListener('click', async () => {
      const staffId = staffSelect.value;
      if (!staffId) return;
      const response = await fetch(`/ticketing/api/expected-amount/${staffId}`);
      const data = await response.json();
      expectedInput.value = data.expected_amount || 0;
      calculateDifference();
    });

    function calculateDifference() {
      const expected = parseFloat(expectedInput.value) || 0;
      const actual = parseFloat(actualInput.value) || 0;
      const diff = actual - expected;
      differenceDiv.textContent = `Difference: ₹${diff.toFixed(2)}`;
      differenceDiv.className = `mt-3 fs-5 fw-bold ${diff < 0 ? 'text-danger' : 'text-success'}`;
    }

    actualInput.addEventListener('input', calculateDifference);
  });
</script>
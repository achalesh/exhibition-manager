<%- include('partials/header') %>

<div class="container mt-4">
    <%- include('partials/ticketingNav') %>

    <div class="card mx-auto" style="max-width: 700px;">
        <div class="card-header">
            <h3><%= title %></h3>
        </div>
        <div class="card-body">
            <!-- Distribution Details -->
            <div class="mb-4 p-3 border rounded bg-light">
                <h5>Distribution Details</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Staff:</strong> <%= dist.staff_name %></p>
                        <p><strong>Ride:</strong> <%= dist.ride_name %></p>
                        <p class="mb-0"><strong>Ticket Rate:</strong> ₹<%= dist.ticket_rate.toFixed(2) %></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Distributed Range:</strong> <%= dist.distributed_start_number %> - <%= dist.distributed_end_number %></p>
                        <p><strong>Total Tickets:</strong> <%= dist.distributed_end_number - dist.distributed_start_number + 1 %></p>
                        <p class="mb-0"><strong>Distribution Date:</strong> <%= new Date(dist.distribution_date).toLocaleDateString() %></p>
                    </div>
                </div>
            </div>

            <!-- Settlement Form -->
            <form action="/ticketing/settle/<%= dist.id %>" method="POST" id="settlement-form">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="settlement_date" class="form-label">Settlement Date</label>
                        <input type="date" class="form-control" id="settlement_date" name="settlement_date" value="<%= new Date().toISOString().split('T')[0] %>" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="returned_start_number" class="form-label">Returned Start Number</label>
                        <input type="number" class="form-control" id="returned_start_number" name="returned_start_number" required autofocus>
                        <div class="form-text">This is the number of the first unsold ticket.</div>
                    </div>
                </div>

                <hr>
                <h5>Sales Calculation</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Tickets Sold:</strong> <span id="tickets-sold" class="fw-bold">0</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Calculated Revenue:</strong> <span id="calculated-revenue" class="fw-bold">₹0.00</span></p>
                    </div>
                </div>

                <hr>
                <h5>Settlement Summary</h5>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Total Collected:</strong> <span id="total-collected" class="fw-bold">₹0.00</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Difference (Short/Excess):</strong> <span id="difference" class="fw-bold text-success">₹0.00</span></p>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="notes" class="form-label">Notes (for shortage/excess)</label>
                    <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Explain any difference in collection..."></textarea>
                </div>

                <hr>
                <h5>Amount Collected</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="cash_amount" class="form-label">Cash Amount</label>
                        <input type="number" step="0.01" class="form-control" id="cash_amount" name="cash_amount" value="0">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="upi_amount" class="form-label">UPI/Digital Amount</label>
                        <input type="number" step="0.01" class="form-control" id="upi_amount" name="upi_amount" value="0">
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-success" id="review-settlement-btn">Review & Confirm Settlement</button>
                    <a href="/ticketing/distribute" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="settlementConfirmModal" tabindex="-1" aria-labelledby="settlementConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settlementConfirmModalLabel">Confirm Settlement Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please review the details before confirming the settlement.</p>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tickets Sold
                        <span class="badge bg-primary rounded-pill" id="modal-tickets-sold">0</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Calculated Revenue
                        <span class="fw-bold" id="modal-calculated-revenue">₹0.00</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Amount Collected
                        <span class="fw-bold" id="modal-total-collected">₹0.00</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center" id="modal-difference-item"></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="final-submit-btn">Confirm & Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const returnedStartInput = document.getElementById('returned_start_number');
        const ticketsSoldSpan = document.getElementById('tickets-sold');
        const calculatedRevenueSpan = document.getElementById('calculated-revenue');
        const cashInput = document.getElementById('cash_amount');
        const upiInput = document.getElementById('upi_amount');
        const totalCollectedSpan = document.getElementById('total-collected');
        const differenceSpan = document.getElementById('difference');
        const settlementForm = document.getElementById('settlement-form');
        const reviewBtn = document.getElementById('review-settlement-btn');
        const finalSubmitBtn = document.getElementById('final-submit-btn');
        const settlementModal = new bootstrap.Modal(document.getElementById('settlementConfirmModal'));

        // Modal spans
        const modalTicketsSold = document.getElementById('modal-tickets-sold');
        const modalCalculatedRevenue = document.getElementById('modal-calculated-revenue');
        const modalTotalCollected = document.getElementById('modal-total-collected');
        const modalDifferenceItem = document.getElementById('modal-difference-item');

        const distributedStart = <%= dist.distributed_start_number %>;
        const ticketRate = <%= dist.ticket_rate %>;
        let calculatedRevenue = 0;

        function updateCalculations() {
            const returnedStart = parseInt(returnedStartInput.value, 10);
            if (isNaN(returnedStart) || returnedStart < distributedStart) {
                ticketsSoldSpan.textContent = '0';
                calculatedRevenueSpan.textContent = '₹0.00';
                calculatedRevenue = 0;
                updateSummary();
                return;
            }
            const ticketsSold = returnedStart - distributedStart;
            calculatedRevenue = ticketsSold * ticketRate;
            ticketsSoldSpan.textContent = ticketsSold;
            calculatedRevenueSpan.textContent = '₹' + calculatedRevenue.toFixed(2);
            updateSummary();
        }

        function updateSummary() {
            const cashAmount = parseFloat(cashInput.value) || 0;
            const upiAmount = parseFloat(upiInput.value) || 0;
            const totalCollected = cashAmount + upiAmount;
            const difference = totalCollected - calculatedRevenue;

            totalCollectedSpan.textContent = '₹' + totalCollected.toFixed(2);
            differenceSpan.textContent = '₹' + difference.toFixed(2);

            differenceSpan.classList.remove('text-success', 'text-danger');
            if (difference > 0) {
                differenceSpan.classList.add('text-success'); // Excess
            } else if (difference < 0) {
                differenceSpan.classList.add('text-danger'); // Shortage
            }
        }

        returnedStartInput.addEventListener('input', updateCalculations);
        cashInput.addEventListener('input', updateSummary);
        upiInput.addEventListener('input', updateSummary);

        reviewBtn.addEventListener('click', function() {
            // Populate modal with current data
            modalTicketsSold.textContent = ticketsSoldSpan.textContent;
            modalCalculatedRevenue.textContent = calculatedRevenueSpan.textContent;
            modalTotalCollected.textContent = totalCollectedSpan.textContent;

            const differenceValue = (parseFloat(totalCollectedSpan.textContent.replace('₹', '')) - parseFloat(calculatedRevenueSpan.textContent.replace('₹', ''))).toFixed(2);
            let differenceHtml = 'Difference (Short/Excess) <span class="fw-bold ';
            if (differenceValue > 0) {
                differenceHtml += 'text-success">';
            } else if (differenceValue < 0) {
                differenceHtml += 'text-danger">';
            } else {
                differenceHtml += '">';
            }
            differenceHtml += `₹${differenceValue}</span>`;
            modalDifferenceItem.innerHTML = differenceHtml;

            settlementModal.show();
        });

        finalSubmitBtn.addEventListener('click', function() {
            settlementForm.submit();
        });
    });
</script>

<%- include('partials/footer') %>
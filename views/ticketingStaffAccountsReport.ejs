<%- include('partials/header') %>

<%- include('partials/ticketingSubNav') %>

<div class="container-fluid mt-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><%= title %></h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="window.print();"><i class="bi bi-printer me-1"></i> Print Report</button>
    </div>
    <div class="card-body">

      <!-- Summary Cards -->
      <div class="row g-3 mb-4 text-center">
        <div class="col-md-6">
          <div class="card bg-danger-subtle h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted">Total Outstanding Shortage</h6>
              <h4 class="card-title">₹<%= summary.totalShortage.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></h4>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-success-subtle h-100">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted">Total Outstanding Excess</h6>
              <h4 class="card-title">₹<%= summary.totalExcess.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Balances Table -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Staff Member</th>
              <th class="text-center">Balance Status</th>
              <th class="text-end">Amount</th>
              <% if (viewingSession.id === activeSession.id) { %>
                <th class="text-center">Actions</th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% if (accounts && accounts.length > 0) { %>
              <% accounts.forEach(account => { %>
                <tr>
                  <td>
                    <a href="/ticketing/report/staff-ledger/<%= account.staff_id %>" title="View Ledger"><%= account.staff_name %></a>
                  </td>
                  <td class="text-center">
                    <% if (account.balance < 0) { %>
                      <span class="badge bg-danger">Shortage</span>
                    <% } else if (account.balance > 0) { %>
                      <span class="badge bg-success">Excess</span>
                    <% } else { %>
                      <span class="badge bg-secondary">Settled</span>
                    <% } %>
                  </td>
                  <td class="text-end fw-bold <%= account.balance < 0 ? 'text-danger' : (account.balance > 0 ? 'text-success' : '') %>">
                    ₹<%= Math.abs(account.balance).toFixed(2) %>
                  </td>
                  <% if (viewingSession.id === activeSession.id) { %>
                    <td class="text-center">
                      <% if (account.balance !== 0) { %>
                        <a href="/ticketing/report/staff-accounts/settle/<%= account.staff_id %>" class="btn btn-sm btn-primary">Settle Balance</a>
                      <% } else { %>
                        <span class="text-muted">N/A</span>
                      <% } %>
                    </td>
                  <% } %>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="4" class="text-center">No staff account balances found for this session.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
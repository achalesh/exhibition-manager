<%- include('partials/header') %>

<div class="container mt-4">
  <div class="card">
    <div class="card-header">
      <h2><%= title %></h2>
    </div>
    <div class="card-body">
      <form action="/material/edit/<%= issue.id %>" method="POST">
        
        <!-- Client and Stall Info -->
        <div class="row mb-3">
          <div class="col-md-5">
            <label for="client_id" class="form-label">Select Exhibitor</label>
            <select class="form-select" id="client_id" name="client_id" required>
              <option value="" disabled>-- Choose an Exhibitor --</option>
              <% clients.forEach(client => { %>
                <option value="<%= client.client_id %>" 
                        data-space-name="<%= client.space_name %>"
                        <%= issue.client_id == client.client_id ? 'selected' : '' %>>
                  <%= client.client_name %> <% if (client.facia_name) { %>(<%= client.facia_name %>) <% } %>- [<%= client.space_name %>]
                </option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-2">
            <label for="sl_no" class="form-label">Sl.No.</label>
            <input type="text" class="form-control" id="sl_no" name="sl_no" value="<%= issue.sl_no || '' %>">
          </div>
          <div class="col-md-2">
            <label for="stall_number" class="form-label">Stall Number</label>
            <input type="text" class="form-control" id="stall_number" name="stall_number" value="<%= issue.stall_number || '' %>" readonly>
          </div>
          <div class="col-md-3 ">
            <label for="camp" class="form-label">Camp</label>
            <input type="text" class="form-control" id="camp" name="camp" list="camp-suggestions" value="<%= issue.camp || '' %>">
            <datalist id="camp-suggestions">
              <% suggestions.camps.forEach(item => { %>
                <option value="<%= item %>">
              <% }) %>
            </datalist>
          </div>
        </div>

        <hr>

        <!-- Free Materials -->
        <h5 class="mt-4">Materials Provided (Free of Cost)</h5>
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="plywood_free" class="form-label">Octonorm Plywood</label>
            <input type="number" class="form-control" id="plywood_free" name="plywood_free" value="<%= issue.plywood_free || 0 %>" min="0">
          </div>
          <div class="col-md-3">
            <label for="table_free" class="form-label">Tables</label>
            <input type="number" class="form-control" id="table_free" name="table_free" value="<%= issue.table_free || 0 %>" min="0">
          </div>
          <div class="col-md-3">
            <label for="chair_free" class="form-label">Chairs</label>
            <input type="number" class="form-control" id="chair_free" name="chair_free" value="<%= issue.chair_free || 0 %>" min="0">
          </div>
          <div class="col-md-3">
            <label for="rod_free" class="form-label">Extra Rod</label>
            <input type="number" class="form-control" id="rod_free" name="rod_free" value="<%= issue.rod_free || 0 %>" min="0">
          </div>
        </div>

        <hr>

        <!-- Chargeable Materials -->
        <h5 class="mt-4">Materials Provided (Chargeable Basis)</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="plywood_paid" class="form-label">Octonorm Plywood (₹600/pc)</label>
            <input type="number" class="form-control chargeable" id="plywood_paid" name="plywood_paid" value="<%= issue.plywood_paid || 0 %>" min="0" data-rate="600">
          </div>
          <div class="col-md-4">
            <label for="table_paid" class="form-label">Tables (₹600/table)</label>
            <input type="number" class="form-control chargeable" id="table_paid" name="table_paid" value="<%= issue.table_paid || 0 %>" min="0" data-rate="600">
          </div>
          <div class="col-md-4">
            <label for="chair_paid" class="form-label">Chairs (₹100/chair)</label>
            <input type="number" class="form-control chargeable" id="chair_paid" name="chair_paid" value="<%= issue.chair_paid || 0 %>" min="0" data-rate="100">
          </div>
        </div>

        <hr>

        <!-- Asset Details -->
        <h5 class="mt-4">Asset Details</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="table_numbers" class="form-label">Provided Table Numbers</label>
            <input type="text" class="form-control" id="table_numbers" name="table_numbers" value="<%= issue.table_numbers || '' %>" placeholder="e.g., T-01, T-05, T-12">
          </div>
          <div class="col-md-6">
            <label for="chair_numbers" class="form-label">Provided Chair Numbers</label>
            <input type="text" class="form-control" id="chair_numbers" name="chair_numbers" value="<%= issue.chair_numbers || '' %>" placeholder="e.g., C-01, C-02, C-08">
          </div>
        </div>

        <hr>

        <!-- Calculation -->
        <h5 class="mt-4">Payment Calculation</h5>
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="total_payable" class="form-label">Total Payable (₹)</label>
            <input type="number" class="form-control" id="total_payable" name="total_payable" value="<%= issue.total_payable || 0 %>" readonly>
          </div>
          <div class="col-md-4">
            <label for="advance_paid" class="form-label">Less: Advance (₹)</label>
            <input type="number" class="form-control" id="advance_paid" name="advance_paid" value="<%= issue.advance_paid || 0 %>" min="0">
          </div>
          <div class="col-md-4">
            <label for="balance_due" class="form-label">Balance Payable (₹)</label>
            <input type="number" class="form-control" id="balance_due" name="balance_due" value="<%= issue.balance_due || 0 %>" readonly>
          </div>
        </div>

        <!-- Notes -->
        <div class="mb-3">
          <label for="notes" class="form-label">Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="3"><%= issue.notes || '' %></textarea>
        </div>

        <input type="hidden" id="issue_date" name="issue_date" value="<%= new Date(issue.issue_date).toISOString().split('T')[0] %>">

        <button type="submit" class="btn btn-primary">Update Issue</button>
        <a href="/booking/details-full/<%= issue.booking_id %>" class="btn btn-secondary">Cancel</a>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const clientSelect = document.getElementById('client_id');
    const stallNumberInput = document.getElementById('stall_number');
    
    clientSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const spaceName = selectedOption.getAttribute('data-space-name');
      stallNumberInput.value = spaceName;
    });

    // Set initial stall number on page load
    if (clientSelect.selectedIndex > 0) {
        const selectedOption = clientSelect.options[clientSelect.selectedIndex];
        stallNumberInput.value = selectedOption.getAttribute('data-space-name');
    }

    // --- Calculation Logic ---
    const chargeableInputs = document.querySelectorAll('.chargeable');
    const advanceInput = document.getElementById('advance_paid');
    
    chargeableInputs.forEach(input => input.addEventListener('input', calculateTotals));
    advanceInput.addEventListener('input', calculateTotals);

    function calculateTotals() {
      let total = 0;
      chargeableInputs.forEach(item => {
        const quantity = parseInt(item.value, 10) || 0;
        const rate = parseFloat(item.getAttribute('data-rate')) || 0;
        total += quantity * rate;
      });
      document.getElementById('total_payable').value = total.toFixed(2);

      const advance = parseFloat(advanceInput.value) || 0;
      const balance = total - advance;
      document.getElementById('balance_due').value = balance.toFixed(2);
    }

    calculateTotals(); // Initial calculation
  });
</script>

<%- include('partials/footer') %>
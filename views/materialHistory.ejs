<%- include('partials/header') %>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1"><%= title %></h2>
      <p class="text-muted mb-0">Unique ID: <span class="font-monospace"><%= material.unique_id %></span></p>
    </div>
    < <form action="/materials/write-off/<%= material.id %>" method="POST" onsubmit="return confirm('Are you sure you want to permanently WRITE OFF this item? This cannot be undone.');">
        <input type="hidden" name="redirectUrl" value="/materials">
        <button type="submit" class="btn btn-danger"><i class="bi bi-trash-fill me-1"></i> Write-Off Item</button>
      </form>
      <a href="/materials" class="btn btn-outline-secondary">Â« Back to Material Stock</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped">
          <thead class="table-light">
            <tr>
              <th>Date & Time</th>
              <th>Action / Status</th>
              <th>Details</th>
              <th>User</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            <% if (history && history.length > 0) { %>
              <% history.forEach(entry => { %>
                <tr>
                  <td><%= new Date(entry.timestamp).toLocaleString() %></td>
                  <td>
                    <span class="badge bg-<%= entry.status === 'Available' ? 'success' : (entry.status === 'Issued' ? 'warning' : 'danger') %>">
                      <%= entry.status %>
                    </span>
                  </td>
                  <td>
                    <% if (entry.status === 'Issued' && entry.client_name) { %>
                      Issued to 
                      <% if (entry.booking_id) { %>
                        <a href="/booking/details-full/<%= entry.booking_id %>"><strong><%= entry.client_name %></strong></a>
                      <% } else { %>
                        <strong><%= entry.client_name %></strong>
                      <% } %>
                    <% } else if (entry.status === 'Available' || entry.status === 'Damaged') { %>
                      Returned to stock
                    <% } %>
                  </td>
                  <td><%= entry.username || 'System' %></td>
                  <td class="text-muted fst-italic"><%= entry.notes || '' %></td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="5" class="text-center text-muted">No history found for this item.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
<%- include('partials/header') %>

<div class="container mt-4">
  <div class="page-header">
    <h1><i class="bi bi-cash-stack"></i> Settle Staff Tickets</h1>
    <p class="text-muted">Record cash received from staff for ticket sales and track any short or excess amounts.</p>
  </div>

  <div class="row">
    <!-- Settlement Form -->
    <div class="col-md-7">
      <div class="card">
        <div class="card-header">
          New Settlement
        </div>
        <div class="card-body">
          <form action="/ticketing/cash-settle" method="POST">
            <div class="mb-3">
              <label for="staff_id" class="form-label">Select Staff</label>
              <select name="staff_id" id="staff_id" class="form-select" required>
                <option value="" disabled selected>-- Choose a staff member --</option>
                <% staffList.forEach(staff => { %>
                  <option value="<%= staff.id %>"><%= staff.name %></option>
                <% }) %>
              </select>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="expected_amount" class="form-label">Expected Amount (₹)</label>
                <div class="input-group">
                  <input type="number" name="expected_amount" id="expected_amount" class="form-control" readonly required>
                  <button class="btn btn-outline-secondary" type="button" id="calculate_btn">Calculate</button>
                </div>
                <small class="form-text text-muted">Based on tickets sold since last settlement.</small>
              </div>
              <div class="col-md-6 mb-3">
                <label for="actual_amount" class="form-label">Actual Cash Received (₹)</label>
                <input type="number" step="0.01" name="actual_amount" id="actual_amount" class="form-control" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="difference" class="form-label">Difference</label>
              <input type="text" id="difference" class="form-control" readonly>
            </div>

            <div class="mb-3">
              <label for="notes" class="form-label">Notes (Optional)</label>
              <textarea name="notes" id="notes" class="form-control" rows="2"></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100">Confirm Settlement</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Unsettled Balances -->
    <div class="col-md-5">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-wallet2"></i> Current Unsettled Balances
        </div>
        <div class="list-group list-group-flush">
          <% if (unsettledTotals.length > 0) { %>
            <% unsettledTotals.forEach(item => { %>
              <div class="list-group-item d-flex justify-content-between align-items-center">
                <%= item.name %>
                <span class="badge bg-<%= item.total_unsettled < 0 ? 'danger' : 'warning' %> rounded-pill">
                  ₹<%= item.total_unsettled.toLocaleString('en-IN') %>
                </span>
              </div>
            <% }) %>
          <% } else { %>
            <div class="list-group-item">All staff accounts are settled.</div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const staffSelect = document.getElementById('staff_id');
  const calculateBtn = document.getElementById('calculate_btn');
  const expectedInput = document.getElementById('expected_amount');
  const actualInput = document.getElementById('actual_amount');
  const differenceInput = document.getElementById('difference');

  calculateBtn.addEventListener('click', async () => {
    const staffId = staffSelect.value;
    if (!staffId) {
      alert('Please select a staff member first.');
      return;
    }
    calculateBtn.disabled = true;
    calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    const response = await fetch(`/ticketing/api/expected-amount/${staffId}`);
    const data = await response.json();
    expectedInput.value = data.expected_amount || 0;
    calculateBtn.disabled = false;
    calculateBtn.textContent = 'Calculate';
    updateDifference();
  });

  actualInput.addEventListener('input', updateDifference);

  function updateDifference() {
    const expected = parseFloat(expectedInput.value) || 0;
    const actual = parseFloat(actualInput.value) || 0;
    const diff = actual - expected;
    differenceInput.value = `₹${diff.toFixed(2)} ${diff < 0 ? '(Short)' : diff > 0 ? '(Excess)' : ''}`;
    differenceInput.className = 'form-control'; // Reset
    if (diff < 0) differenceInput.classList.add('is-invalid');
    if (diff > 0) differenceInput.classList.add('is-valid');
  }
</script>

<%- include('partials/footer') %>
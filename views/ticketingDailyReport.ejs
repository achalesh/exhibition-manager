<%- include('partials/header') %>

<div class="container-fluid">
  <div class="no-print">
    <%- include('partials/ticketingNav') %>
  </div>

  <!-- Grand Total Summary Cards -->
  <div class="row no-print">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-primary border-3 shadow-sm h-100 py-2">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Revenue</div>
              <div class="h5 mb-0 fw-bold text-body">₹<%= grandTotal.revenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
            </div>
            <div class="col-auto"><i class="bi bi-currency-rupee fs-2 text-secondary"></i></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-info border-3 shadow-sm h-100 py-2">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-info text-uppercase mb-1">Total Tickets Sold</div>
              <div class="h5 mb-0 fw-bold text-body"><%= grandTotal.tickets.toLocaleString('en-IN') %></div>
            </div>
            <div class="col-auto"><i class="bi bi-ticket-perforated fs-2 text-secondary"></i></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-success border-3 shadow-sm h-100 py-2">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-success text-uppercase mb-1">Total UPI Collection</div>
              <div class="h5 mb-0 fw-bold text-body">₹<%= grandTotal.upi.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
            </div>
            <div class="col-auto"><i class="bi bi-phone-fill fs-2 text-secondary"></i></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-secondary border-3 shadow-sm h-100 py-2">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col mr-2">
              <div class="text-xs fw-bold text-secondary text-uppercase mb-1">Total Cash Collection</div>
              <div class="h5 mb-0 fw-bold text-body">₹<%= grandTotal.cash.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
            </div>
            <div class="col-auto"><i class="bi bi-wallet2 fs-2 text-secondary"></i></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="card shadow-sm mb-4 no-print">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Filter by Date</h6>
    </div>
    <div class="card-body">
      <form action="/ticketing/report/daily" method="GET" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="start_date" name="start_date" value="<%= filters.start_date %>">
        </div>
        <div class="col-md-4">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" class="form-control" id="end_date" name="end_date" value="<%= filters.end_date %>">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
        <div class="col-md-2">
          <a href="/ticketing/report/daily" class="btn btn-secondary w-100">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Print Button -->
  <div class="mb-4 no-print">
    <button onclick="window.print()" class="btn btn-secondary"><i class="bi bi-printer-fill me-2"></i>Print Report</button>
  </div>

  <!-- Chart Section -->
  <div class="card shadow-sm mb-4 no-print">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Daily Sales Trend</h6>
    </div>
    <div class="card-body">
      <canvas id="dailySalesChart" style="max-height: 350px;"></canvas>
    </div>
  </div>

  <!-- Report Table -->
  <div class="card shadow-sm mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 fw-bold text-primary">Sales Summary</h6>
    </div>
    <div class="card-body">
      <% if (Object.keys(salesByDate).length === 0) { %>
        <p class="text-center text-muted">No sales data found for the selected period.</p>
      <% } else { %>
        <% Object.keys(salesByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => { %>
          <h5 class="mt-4 mb-3">Date: <%= new Date(date).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr>
                  <th>Ride Name</th>
                  <th class="text-end">Tickets Sold</th>
                  <th class="text-end">Revenue (₹)</th>
                </tr>
              </thead>
              <tbody>
                <% salesByDate[date].rides.forEach(ride => { %>
                  <tr>
                    <td><%= ride.ride_name %> (₹<%= ride.rate %>)</td>
                    <td class="text-end"><%= ride.total_tickets_sold %></td>
                    <td class="text-end"><%= ride.total_revenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                  </tr>
                <% }) %>
              </tbody>
              <tfoot>
                <tr class="fw-bold">
                  <td class="text-end pt-3">Daily Total:</td>
                  <td class="text-end"><%= salesByDate[date].daily_total_tickets %></td>
                  <td class="text-end">₹<%= salesByDate[date].daily_total_revenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                </tr>
                <tr>
                  <td colspan="2" class="text-end border-0 text-muted">UPI Collection:</td>
                  <td class="text-end border-0 text-muted">₹<%= salesByDate[date].daily_total_upi.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                </tr>
                <tr>
                  <td colspan="2" class="text-end border-0 text-muted">Cash Collection:</td>
                  <td class="text-end border-0 text-muted">₹<%= salesByDate[date].daily_total_cash.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                </tr>
              </tfoot>
            </table>
          </div>
        <% }) %>
      <% } %>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const salesByDate = <%- JSON.stringify(salesByDate) %>;
    const sortedDates = Object.keys(salesByDate).sort((a, b) => new Date(a) - new Date(b));

    if (sortedDates.length > 0) {
      const chartLabels = sortedDates.map(date => new Date(date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }));
      const revenueData = sortedDates.map(date => salesByDate[date].daily_total_revenue);

      const ctx = document.getElementById('dailySalesChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Total Revenue (₹)',
            data: revenueData,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) { return '₹' + value.toLocaleString('en-IN'); }
              }
            }
          }
        }
      });
    }
  });
</script>
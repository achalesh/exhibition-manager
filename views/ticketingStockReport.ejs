<%- include('partials/header') %>

<%- include('partials/ticketingSubNav') %>

<div class="container-fluid mt-4">
  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><%= title %></h4>
      <button class="btn btn-sm btn-outline-secondary" onclick="window.print();"><i class="bi bi-printer me-1"></i> Print Report</button>
    </div>
    <div class="card-body">

      <!-- Summary Cards -->
      <div class="row g-3 mb-4 text-center">
        <% const statusOrder = ['Available', 'Distributed', 'Settled', 'Cancelled']; %>
        <% statusOrder.forEach(status => { %>
          <div class="col-md-3">
            <div class="card h-100">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted"><%= status %></h6>
                <h4 class="card-title"><%= (summaryCounts[status] || 0).toLocaleString('en-IN') %></h4>
              </div>
            </div>
          </div>
        <% }); %>
      </div>

      <!-- Filter Form -->
      <form method="GET" action="/ticketing/report/stock" class="row g-3 align-items-end bg-light p-3 rounded mb-4">
        <div class="col-md-4">
          <label for="status" class="form-label">Status</label>
          <select class="form-select" id="status" name="status">
            <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>All Statuses</option>
            <option value="Available" <%= filters.status === 'Available' ? 'selected' : '' %>>Available</option>
            <option value="Distributed" <%= filters.status === 'Distributed' ? 'selected' : '' %>>Distributed</option>
            <option value="Settled" <%= filters.status === 'Settled' ? 'selected' : '' %>>Settled</option>
            <option value="Cancelled" <%= filters.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="rate" class="form-label">Rate</label>
          <select class="form-select" id="rate" name="rate">
            <option value="all" <%= filters.rate === 'all' ? 'selected' : '' %>>All Rates</option>
            <% allRates.forEach(r => { %>
              <option value="<%= r.rate %>" <%= filters.rate == r.rate ? 'selected' : '' %>>₹<%= r.rate %></option>
            <% }); %>
          </select>
        </div>
        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">Filter</button>
          <a href="/ticketing/report/stock" class="btn btn-secondary flex-grow-1">Clear</a>
        </div>
      </form>

      <!-- Stock Table -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm">
          <thead class="table-dark">
            <tr>
              <th>Rate</th>
              <th>Color</th>
              <th>Start No.</th>
              <th>End No.</th>
              <th>Status</th>
              <th>Distributed To</th>
              <th>Date Entered</th>
            </tr>
          </thead>
          <tbody>
            <% if (stock && stock.length > 0) { %>
              <% stock.forEach(item => { %>
                <tr>
                  <td>₹<%= item.rate %></td>
                  <td><%= item.color %></td>
                  <td><%= item.start_number %></td>
                  <td><%= item.end_number %></td>
                  <td><span class="badge bg-<%= item.status === 'Available' ? 'success' : (item.status === 'Distributed' ? 'warning text-dark' : (item.status === 'Settled' ? 'primary' : 'secondary')) %>"><%= item.status %></span></td>
                  <td><%= item.staff_name || 'N/A' %></td>
                  <td><%= new Date(item.created_at).toLocaleDateString('en-IN') %></td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="7" class="text-center">No stock found for the selected filters.</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination.totalPages > 1) { %>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center mt-4">
            <% for (let i = 1; i <= pagination.totalPages; i++) { %>
              <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
                <a class="page-link" href="/ticketing/report/stock?page=<%= i %>&status=<%= filters.status %>&rate=<%= filters.rate %>"><%= i %></a>
              </li>
            <% } %>
          </ul>
        </nav>
      <% } %>

    </div>
  </div>
</div>

<%- include('partials/footer') %>
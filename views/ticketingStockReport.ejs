<%- include('partials/header') %>

<style>
  @media print {
    @page {
      size: A4 portrait;
      margin: 1.5cm;
    }
    .no-print {
      display: none;
    }
    .card {
      border: none;
      box-shadow: none;
    }
  }
</style>

<div class="container-fluid">
  <%- include('partials/ticketingNav') %>

  <div class="d-flex justify-content-between align-items-center mb-3 no-print">
    
    <button class="btn btn-sm btn-outline-secondary" onclick="window.print()">
      <i class="bi bi-printer me-1"></i> Print Report
    </button>
  </div>

  <!-- Filter Form -->
  <div class="card shadow-sm mb-4 no-print">
    <div class="card-body">
      <form method="GET" action="/ticketing/report/stock" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="rate" class="form-label">Filter by Rate</label>
          <select id="rate" name="rate" class="form-select">
            <option value="all" <%= filters.rate === 'all' ? 'selected' : '' %>>All Rates</option>
            <% allRates.forEach(r => { %>
              <option value="<%= r.rate %>" <%= parseFloat(filters.rate) === r.rate ? 'selected' : '' %>>₹<%= r.rate.toFixed(2) %></option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
        <div class="col-md-2">
          <a href="/ticketing/report/stock" class="btn btn-outline-secondary w-100">Clear</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab Navigation -->
  <ul class="nav nav-tabs no-print" id="reportTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-pane" type="button" role="tab" aria-controls="summary-pane" aria-selected="true">Summary Table</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts-pane" type="button" role="tab" aria-controls="charts-pane" aria-selected="false">Visual Charts</button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="reportTabContent">
    <div class="tab-pane fade show active" id="summary-pane" role="tabpanel" aria-labelledby="summary-tab">
      <div class="card shadow-sm card-tab">
        <div class="card-header py-3">
          <h6 class="m-0 fw-bold text-primary">Stock Summary by Color and Rate</h6>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped" width="100%" cellspacing="0">
              <thead class="table-light">
                <tr>
                  <th>Color</th>
                  <th class="text-end">Rate (₹)</th>
                  <th class="text-end">Initial Stock</th>
                  <th class="text-end">Distributed</th>
                  <th class="text-end">Sold</th>
                  <th class="text-end">Available</th>
                </tr>
              </thead>
              <tbody>
                <% 
                let totalInitial = 0;
                let totalDistributed = 0;
                let totalSold = 0;
                let totalAvailable = 0;
                stockSummary.forEach(item => { 
                  totalInitial += item.initial_stock;
                  totalDistributed += item.distributed_stock;
                  totalSold += item.sold_stock;
                  totalAvailable += item.available_stock;
                %>
                  <tr>
                    <td><span class="badge fs-6" style="background-color: <%= item.color.toLowerCase() %>; color: #fff; text-shadow: 1px 1px 2px #000;"><%= item.color %></span></td>
                    <td class="text-end"><%= item.rate.toFixed(2) %></td>
                    <td class="text-end"><%= item.initial_stock.toLocaleString('en-IN') %></td>
                    <td class="text-end"><%= item.distributed_stock.toLocaleString('en-IN') %></td>
                    <td class="text-end"><%= (item.sold_stock || 0).toLocaleString('en-IN') %></td>
                    <td class="text-end fw-bold"><%= item.available_stock.toLocaleString('en-IN') %></td>
                  </tr>
                <% }) %>
              </tbody>
              <tfoot class="table-dark fw-bold">
                <tr>
                  <td colspan="2" class="text-end">Grand Total</td>
                  <td class="text-end"><%= totalInitial.toLocaleString('en-IN') %></td>
                  <td class="text-end"><%= totalDistributed.toLocaleString('en-IN') %></td>
                  <td class="text-end"><%= totalSold.toLocaleString('en-IN') %></td>
                  <td class="text-end"><%= totalAvailable.toLocaleString('en-IN') %></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="charts-pane" role="tabpanel" aria-labelledby="charts-tab">
      <div class="card shadow-sm card-tab no-print">
        <div class="card-header py-3">
          <h6 class="m-0 fw-bold text-primary">Available Stock by Rate and Color</h6>
        </div>
        <div class="card-body" style="height: 50vh;">
          <canvas id="stockChart" style="max-height: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>
</div>

<style>
  .card-tab {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    border-top: 0;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('stockChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: <%- JSON.stringify(chartData) %>,
      options: {
        plugins: {
          title: {
            display: true,
            text: 'Available Ticket Stock'
          },
        },
        responsive: true,
        scales: {
          x: {
            stacked: false,
          },
          y: {
            stacked: false
          }
        }
      }
    });

  });
</script>

<%- include('partials/footer') %>